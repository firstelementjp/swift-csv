const{__:__}=window.wp.i18n||{__:e=>e};function initLoggingSystem(){const e=document.querySelector("#export-log-content"),t=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+__("Ready to start export...","swift-csv")+"</div>"),t&&(t.innerHTML='<div class="log-entry log-info">'+__("Ready to start import...","swift-csv")+"</div>")}function addLogEntry(e,t="info",o="export"){const r=document.querySelector(`#${o}-log-content`);if(!r)return;const s=document.createElement("div");s.className=`log-entry log-${t}`;const n=(new Date).toLocaleTimeString();s.textContent=`[${n}] ${e}`,r.appendChild(s),r.scrollTop=r.scrollHeight;const c=r.querySelectorAll(".log-entry");c.length>100&&c[0].remove()}function clearLog(e="export"){const t=document.querySelector(`#${e}-log-content`);t&&(t.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),t=document.querySelector("#ajax_csv_file"),o=document.querySelector("#csv-file-info"),r=document.querySelector("#remove-file-btn");function s(t){if(!t.name.toLowerCase().endsWith(".csv"))return void addLogEntry(__("Please select a CSV file","swift-csv"),"error","import");if(t.size>10485760)return void addLogEntry(__("File size exceeds 10MB limit","swift-csv"),"error","import");const r=o.querySelector(".file-name");r&&(r.textContent=t.name),e.style.display="none",o.style.display="flex",addLogEntry(__("File selected:","swift-csv")+" "+t.name,"success","import")}e&&t&&(e.addEventListener("click",()=>{t.click()}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");const o=t.dataTransfer.files;o.length>0&&s(o[0])}),t.addEventListener("change",e=>{e.target.files.length>0&&s(e.target.files[0])}),r&&r.addEventListener("click",()=>{t.value="",e.style.display="block",o.style.display="none",addLogEntry(__("File removed","swift-csv"),"info","import")}))}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(__("Starting export process...","swift-csv"),"info","export");const t=document.querySelector("#ajax_export_post_type")?.value,o=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",r=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",s=document.querySelector("#export_limit")?.value||"";addLogEntry(__("Post Type:","swift-csv")+" "+t,"debug","export"),addLogEntry(__("Export Scope:","swift-csv")+" "+o,"debug","export"),addLogEntry(__("Include Private Meta:","swift-csv")+" "+__("1"===r?"Yes":"No","swift-csv"),"debug","export"),addLogEntry(__("Export Limit:","swift-csv")+" "+(s||__("No limit","swift-csv")),"debug","export");const n=document.querySelector("#ajax-export-csv-btn"),c=document.querySelector("#ajax-export-cancel-btn"),a=Date.now();let i=!1;n&&(n.disabled=!0,n.value=__("Exporting...","swift-csv")),c&&(c.style.display="inline-block");let d="";c&&c.addEventListener("click",function(){i=!0,addLogEntry(__("Export cancelled by user","swift-csv"),"warning","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),c&&(c.style.display="none")}),function e(l=0){if(i)return;addLogEntry(__("Processing chunk starting from row","swift-csv")+" "+l,"debug","export");const p=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:t,export_scope:o,include_private_meta:r,export_limit:s,start_row:l});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:p}).then(e=>e.json()).then(o=>{if(!o.success)throw new Error(o.data||"Export failed");if(o.csv_chunk&&(d+=o.csv_chunk),updateAjaxProgress(o,a),o.processed&&o.total){const e=Math.round(o.processed/o.total*100);addLogEntry(__("Processed","swift-csv")+" "+o.processed+"/"+o.total+" ("+e+"%)","info","export")}o.continue&&!i?setTimeout(()=>e(o.processed),100):completeAjaxExport(d,n,c,t)}).catch(e=>{console.error("Export error:",e),addLogEntry(__("Export error:","swift-csv")+" "+e.message,"error","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),c&&(c.style.display="none")})}()}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(__("Starting import process...","swift-csv"),"info","import");const t=document.querySelector("#ajax_csv_file"),o=document.querySelector("#ajax_post_type")?.value,r=document.querySelector("#ajax_update_existing")?.checked;if(!t||!t.files.length)return void addLogEntry(__("Please select a CSV file","swift-csv"),"error","import");const s=t.files[0];addLogEntry(__("File:","swift-csv")+" "+s.name,"debug","import"),addLogEntry(__("File Size:","swift-csv")+" "+formatFileSize(s.size),"debug","import"),addLogEntry(__("Post Type:","swift-csv")+" "+o,"debug","import"),addLogEntry(__("Update Existing:","swift-csv")+" "+__(r?"Yes":"No","swift-csv"),"debug","import");const n=new FormData;n.append("action","swift_csv_ajax_import"),n.append("nonce",swiftCSV.nonce),n.append("csv_file",s),n.append("post_type",o),n.append("update_existing",r?"1":"0");const c=e.target.querySelector('button[type="submit"]'),a=document.querySelector("#ajax-import-cancel-btn"),i=Date.now();let d=!1;c&&(c.disabled=!0,c.textContent=__("Importing...","swift-csv")),a&&(a.style.display="inline-block"),a&&a.addEventListener("click",function(){d=!0,addLogEntry(__("Import cancelled by user","swift-csv"),"warning","import"),c&&(c.disabled=!1,c.textContent=__("Start Import","swift-csv")),a&&(a.style.display="none")}),function e(t=0){d||(addLogEntry(__("Processing chunk starting from row","swift-csv")+" "+t,"debug","import"),n.set("start_row",t),fetch(swiftCSV.ajaxUrl,{method:"POST",body:n}).then(e=>e.json()).then(t=>{if(!t.success)throw new Error(t.data||"Import failed");if(updateImportProgress(t,i),t.processed&&t.total){const e=Math.round(t.processed/t.total*100);addLogEntry(__("Processed","swift-csv")+" "+t.processed+"/"+t.total+" ("+e+"%)","info","import")}void 0!==t.created&&addLogEntry(__("Created:","swift-csv")+" "+t.created,"success","import"),void 0!==t.updated&&addLogEntry(__("Updated:","swift-csv")+" "+t.updated,"success","import"),t.errors>0&&addLogEntry(__("Errors:","swift-csv")+" "+t.errors,"warning","import"),t.continue&&!d?setTimeout(()=>e(t.processed),100):completeAjaxImport(t,c,a)}).catch(e=>{console.error("Import error:",e),addLogEntry(__("Import error:","swift-csv")+" "+e.message,"error","import"),c&&(c.disabled=!1,c.textContent=__("Start Import","swift-csv")),a&&(a.style.display="none")}))}()}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function updateAjaxProgress(e,t){const o=document.querySelector(".swift-csv-progress");if(!o)return void console.warn("Progress container not found");const r=o.querySelector(".progress-bar-fill"),s=o.querySelector(".processed-rows"),n=o.querySelector(".total-rows"),c=o.querySelector(".percentage");r&&void 0!==e.progress&&(r.style.width=e.progress+"%"),s&&void 0!==e.processed&&(s.textContent=e.processed),n&&void 0!==e.total&&(n.textContent=e.total),c&&void 0!==e.progress&&(c.textContent=e.progress)}function updateImportProgress(e,t){const o=document.querySelector(".swift-csv-progress");if(!o)return void console.warn("Progress container not found");const r=o.querySelector(".progress-bar-fill"),s=o.querySelector(".processed-rows"),n=o.querySelector(".total-rows"),c=o.querySelector(".percentage"),a=o.querySelector(".created-count"),i=o.querySelector(".updated-count"),d=o.querySelector(".error-count");r&&void 0!==e.progress&&(r.style.width=e.progress+"%"),s&&void 0!==e.processed&&(s.textContent=e.processed),n&&void 0!==e.total&&(n.textContent=e.total),c&&void 0!==e.progress&&(c.textContent=e.progress),a&&void 0!==e.created&&(a.textContent=e.created),i&&void 0!==e.updated&&(i.textContent=e.updated),d&&void 0!==e.errors&&(d.textContent=e.errors)}function completeAjaxExport(e,t,o,r){addLogEntry(__("Export completed successfully!","swift-csv"),"success","export");const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),c=new Date,a=`swiftcsv_export_${r}_${c.getFullYear()+"-"+String(c.getMonth()+1).padStart(2,"0")+"-"+String(c.getDate()).padStart(2,"0")+"_"+String(c.getHours()).padStart(2,"0")+"-"+String(c.getMinutes()).padStart(2,"0")+"-"+String(c.getSeconds()).padStart(2,"0")}.csv`,i=document.querySelector("#ajax-export-download-link a");i&&(i.href=n,i.download=a,i.parentElement.style.display="block"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),o&&(o.style.display="none"),addLogEntry(__("Download ready:","swift-csv")+" "+a,"info","export")}function completeAjaxImport(e,t,o){addLogEntry(__("Import completed!","swift-csv"),"success","import"),void 0!==e.imported&&addLogEntry(__("Total imported:","swift-csv")+" "+e.imported,"success","import"),void 0!==e.updated&&addLogEntry(__("Total updated:","swift-csv")+" "+e.updated,"success","import"),void 0!==e.errors&&addLogEntry(__("Total errors:","swift-csv")+" "+e.errors,e.errors>0?"warning":"success","import"),t&&(t.disabled=!1,t.textContent=__("Start Import","swift-csv")),o&&(o.style.display="none");const r=document.querySelector("#ajax_csv_file"),s=document.querySelector("#csv-file-upload"),n=document.querySelector("#csv-file-info");r&&(r.value=""),s&&(s.style.display="block"),n&&(n.style.display="none")}function startBatchExport(e,t){addLogEntry(__("Batch export started","swift-csv"),"info","export")}document.addEventListener("DOMContentLoaded",function(){initLoggingSystem();const e=document.querySelector("#export-csv-btn");e&&e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector("#post_type")?.value,o=document.querySelector("#posts_per_page")?.value;!t||!o||o<1?addLogEntry(__("An error occurred. Please try again.","swift-csv"),"error"):startBatchExport(t,o)});const t=document.querySelector("#swift-csv-ajax-export-form");t&&t.addEventListener("submit",handleAjaxExport);const o=document.querySelector("#swift-csv-ajax-import-form");o&&o.addEventListener("submit",handleAjaxImport),initFileUpload()});