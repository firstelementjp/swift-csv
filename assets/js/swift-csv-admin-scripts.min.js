function __(e,t="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,t):e}function swiftCSVLog(e,t="info"){if(window.swiftCSV&&window.swiftCSV.debug){const s=new Date().toISOString(),n=`[Swift CSV] ${e}`;switch(t){case"warn":console.warn(n,s);break;case"error":console.error(n,s);break;default:console.info(n,s)}}}document.addEventListener("DOMContentLoaded",function(){swiftCSVLog("JavaScript initialized"),initLoggingSystem();const e=document.querySelectorAll('input[name="swift_csv_export_scope"]'),t=document.getElementById("custom-export-help");e.length&&t&&(swiftCSVLog("Export scope toggle initialized"),e.forEach(u=>{u.addEventListener("change",function(){t.style.display=this.value==="custom"?"block":"none"})})),initFileUpload();const s=document.querySelector("#swift-csv-ajax-export-form");s&&(swiftCSVLog("Ajax export form initialized"),s.addEventListener("submit",handleAjaxExport));const n=document.querySelector("#swift-csv-ajax-import-form");n&&(swiftCSVLog("Ajax import form initialized"),n.addEventListener("submit",handleAjaxImport)),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),t=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),t&&(t.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,t="info",s="export"){const n=document.querySelector(`#${s}-log-content`);if(!n)return;const u=document.createElement("div");u.className=`log-entry log-${t}`;const l=new Date().toLocaleTimeString();u.textContent=`[${l}] ${e}`,n.appendChild(u),n.scrollTop=n.scrollHeight;const o=100,c=n.querySelectorAll(".log-entry");c.length>o&&c[0].remove()}function clearLog(e="export"){const t=document.querySelector(`#${e}-log-content`);t&&(t.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),t=document.querySelector("#ajax_csv_file"),s=document.querySelector("#csv-file-info"),n=document.querySelector("#remove-file-btn");if(!e||!t||e.dataset.swiftCsvInitialized==="true")return;e.dataset.swiftCsvInitialized="true",t.addEventListener("change",o=>{o.target.files.length>0&&l(o.target.files[0])});let u=!1;e.addEventListener("click",function(o){u||(u=!0,setTimeout(()=>{try{t.click()}catch(c){console.error("Error calling fileInput.click():",c)}finally{setTimeout(()=>{u=!1},100)}},0))},!1),e.addEventListener("dragover",o=>{o.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",o=>{o.preventDefault(),e.classList.remove("dragover");const c=o.dataTransfer.files;c.length>0&&l(c[0])}),n&&n.addEventListener("click",()=>{t.value="",e.style.display="block",s.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")});function l(o){if(!o.name.toLowerCase().endsWith(".csv")){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const c=10*1024*1024;if(o.size>c){swiftCSVLog(`File size validation failed: ${o.size} bytes exceeds ${c} bytes`,"warn"),addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");return}swiftCSVLog(`File selected: ${o.name} (${o.size} bytes)`);const a=s.querySelector(".file-name");a&&(a.textContent=o.name),e.style.display="none",s.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+o.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const t=document.querySelector("#ajax_export_post_type")?.value,s=document.querySelector('input[name="swift_csv_export_scope"]:checked')?.value||"basic",n=document.querySelector('input[name="swift_csv_include_private_meta"]')?.checked?"1":"0",u=document.querySelector('input[name="swift_csv_export_taxonomy_format"]:checked')?.value||"name",l=document.querySelector("#swift_csv_export_limit")?.value||"",o=(Date.now().toString(36)+Math.random().toString(36).slice(2)).replace(/\./g,"");addLogEntry(swiftCSV.messages.postTypeExport+" "+t,"debug","export");const c=s==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+c,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(n==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(l||swiftCSV.messages.noLimit),"debug","export");const a=document.querySelector("#ajax-export-csv-btn"),d=document.querySelector("#ajax-export-cancel-btn"),_=Date.now();let p=!1;a&&(a.disabled=!0,a.value=swiftCSV.messages.exporting),d&&(d.style.display="inline-block");const f=document.querySelector("#export-download-btn");f&&(f.classList.remove("enabled"),f.href="#",f.removeAttribute("download"));let w="",m=null,g=null;d&&(g&&d.removeEventListener("click",g),g=function(){p=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),m&&m.abort();const y=new URLSearchParams({action:"swift_csv_cancel_export",nonce:swiftCSV.nonce,export_session:o});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:y}).catch(()=>{}),a&&(a.disabled=!1,a.value=swiftCSV.messages.exportCsv),d&&(d.style.display="none")},d.addEventListener("click",g,{once:!0}));function S(y=0){if(p)return;m=new AbortController,addLogEntry(swiftCSV.messages.processingChunk+" "+y,"debug","import");const r=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:t,export_scope:s,include_private_meta:n,taxonomy_format:u,export_limit:l,start_row:y,export_session:o});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r,signal:m.signal}).then(i=>i.json()).then(i=>{if(!i.success)throw new Error(i.data||"Export failed");if(i.csv_chunk&&(w+=i.csv_chunk),updateAjaxProgress(i,_),i.processed&&i.total){const v=Math.round(i.processed/i.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+i.processed+"/"+i.total+" ("+v+"%)","info","export")}i.continue&&!p?setTimeout(()=>S(i.processed),100):completeAjaxExport(w,a,d,t)}).catch(i=>{i&&i.name==="AbortError"||(console.error("Export error:",i),addLogEntry(swiftCSV.messages.exportError+" "+i.message,"error","export"),a&&(a.disabled=!1,a.value=swiftCSV.messages.exportCsv),d&&(d.style.display="none"))})}S()}function handleAjaxImport(e){e.preventDefault(),clearLog("import");const t=document.querySelector("#ajax_csv_file"),s=document.querySelector("#ajax_post_type")?.value,n=document.querySelector("#ajax_update_existing")?.checked,u=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",l=document.querySelector("#dry_run")?.checked||!1;if(l&&addLogEntry("[Dry Run] "+swiftCSV.messages.dryRunNotice,"info","import"),addLogEntry(swiftCSV.messages.startingImport,"info","import"),!t||!t.files.length){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const o=t.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+o.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(o.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+s,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(n?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const c=new FormData;c.append("action","swift_csv_ajax_import"),c.append("nonce",swiftCSV.nonce),c.append("csv_file",o),c.append("post_type",s),c.append("update_existing",n?"1":"0"),c.append("taxonomy_format",u),c.append("dry_run",l?"1":"0");const a=e.target.querySelector('button[type="submit"]'),d=document.querySelector("#ajax-import-cancel-btn"),_=Date.now();let p=!1,f=[];swiftCSVLog(`Import started: post_type=${s}, update_existing=${n}, taxonomy_format=${u}, dry_run=${l}`),a&&(a.disabled=!0,a.textContent=swiftCSV.messages.importing),d&&(d.style.display="inline-block"),d&&d.addEventListener("click",function(){p=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),a&&(a.disabled=!1,a.textContent=swiftCSV.messages.startImport),d&&(d.style.display="none")});function w(m=0,g=0,S=0,y=0){p||(addLogEntry(swiftCSV.messages.processingChunk+" "+m,"debug","import"),c.set("start_row",m),c.set("cumulative_created",g),c.set("cumulative_updated",S),c.set("cumulative_errors",y),fetch(swiftCSV.ajaxUrl,{method:"POST",body:c}).then(r=>r.json()).then(r=>{if(!r.success)throw new Error(r.error||"Import failed");if(updateImportProgress(r,_),r.processed&&r.total){const i=Math.round(r.processed/r.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+r.processed+"/"+r.total+" ("+i+"%)","info","import")}if(l&&(console.log("Dry run details:",r.dry_run_details),r.dry_run_details&&Array.isArray(r.dry_run_details)&&r.dry_run_details.length>0&&(addLogEntry(`[Dry Run] \u30D0\u30C3\u30C1\u7D50\u679C (${r.dry_run_details.length}\u4EF6):`,"info","import"),r.dry_run_details.forEach(i=>{const v=i.status==="success"?"\u2713":"\u2717",x=i.action==="create"?"\u65B0\u898F\u4F5C\u6210":"\u66F4\u65B0",C=`[Dry Run] ${v} \u884C${i.row}: ${x} - "${i.title}"`;addLogEntry(C,i.status==="success"?"success":"error","import"),i.details&&addLogEntry(`    ${i.details}`,"debug","import")})),r.dry_run_details&&Array.isArray(r.dry_run_details)&&r.dry_run_details.length>0&&(f=f.concat(r.dry_run_details)),!r.continue&&f.length>0&&addLogEntry(`[Dry Run] \u51E6\u7406\u5B8C\u4E86: \u5408\u8A08 ${f.length}\u4EF6`,"success","import"),r.dry_run_log&&Array.isArray(r.dry_run_log)&&r.dry_run_log.length>0&&r.dry_run_log.forEach(i=>{i&&i.trim()!==""&&addLogEntry("[Dry Run] "+i,"info","import")})),r.cumulative_created!==void 0){const i=l?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.createdInfo;addLogEntry(i+" "+r.cumulative_created,"success","import")}if(r.cumulative_updated!==void 0){const i=l?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.updatedInfo;addLogEntry(i+" "+r.cumulative_updated,"info","import")}r.cumulative_errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+r.cumulative_errors,"warning","import"),r.continue&&!p?setTimeout(()=>w(r.processed,r.cumulative_created,r.cumulative_updated,r.cumulative_errors),100):completeAjaxImport(r,a,d)}).catch(r=>{console.error("Import error:",r);let i=r.message;i==="Import failed"&&r.message.includes("Format mismatch detected")&&(i=r.message),addLogEntry(swiftCSV.messages.importError+" "+i,"error","import"),a&&(a.disabled=!1,a.textContent=swiftCSV.messages.startImport),d&&(d.style.display="none")}))}w()}function formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(2))+" "+s[n]}function updateAjaxProgress(e,t){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const n=s.querySelector(".progress-bar-fill"),u=s.querySelector(".processed-rows"),l=s.querySelector(".total-rows"),o=s.querySelector(".percentage");n&&e.progress!==void 0&&(n.style.width=e.progress+"%"),u&&e.processed!==void 0&&(u.textContent=e.processed),l&&e.total!==void 0&&(l.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress)}function updateImportProgress(e,t){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const n=s.querySelector(".progress-bar-fill"),u=s.querySelector(".processed-rows"),l=s.querySelector(".total-rows"),o=s.querySelector(".percentage"),c=s.querySelector(".created-count"),a=s.querySelector(".updated-count"),d=s.querySelector(".error-count");n&&e.progress!==void 0&&(n.style.width=e.progress+"%"),u&&e.processed!==void 0&&(u.textContent=e.processed),l&&e.total!==void 0&&(l.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress),c&&e.cumulative_created!==void 0&&(c.textContent=e.cumulative_created),a&&e.cumulative_updated!==void 0&&(a.textContent=e.cumulative_updated),d&&e.cumulative_errors!==void 0&&(d.textContent=e.cumulative_errors)}function completeAjaxExport(e,t,s,n){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const u=new Blob([e],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(u),o=new Date,c=o.getFullYear()+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0")+"_"+String(o.getHours()).padStart(2,"0")+"-"+String(o.getMinutes()).padStart(2,"0")+"-"+String(o.getSeconds()).padStart(2,"0"),a=`swiftcsv_export_${n}_${c}.csv`,d=document.querySelector("#export-download-btn");d&&(d.href=l,d.download=a,d.classList.add("enabled")),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),s&&(s.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+a,"info","export")}function completeAjaxImport(e,t,s){const n=e.dry_run||!1;if(addLogEntry(n?"[Dry Run] "+swiftCSV.messages.dryRunCompleted:swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0){const c=n?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.totalImported+" ";addLogEntry(c+e.cumulative_created,"success","import")}if(e.cumulative_updated!==void 0){const c=n?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.totalUpdated+" ";addLogEntry(c+e.cumulative_updated,"success","import")}if(e.cumulative_errors!==void 0){const c=n?"[Dry Run] "+swiftCSV.messages.dryRunErrors+" ":swiftCSV.messages.totalErrors+" ";addLogEntry(c+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import")}t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none");const u=document.querySelector("#ajax_csv_file"),l=document.querySelector("#csv-file-upload"),o=document.querySelector("#csv-file-info");u&&(u.value=""),l&&(l.style.display="block"),o&&(o.style.display="none")}const licenseInput=document.getElementById("swift_csv_pro_license_key_input"),licenseToggle=document.getElementById("swift_csv_pro_license_toggle_visibility");licenseInput&&licenseToggle&&licenseToggle.addEventListener("click",()=>{const e=licenseInput.type==="password";licenseInput.type=e?"text":"password",licenseToggle.textContent=e?swiftCSV.messages.hide:swiftCSV.messages.show});async function wpPost(e,t={}){const s=new URLSearchParams({action:e,...t});return(await fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s})).json()}document.body.addEventListener("click",async e=>{const t=e.target.closest(".swift-csv-license-button");if(!t)return;const s=t.dataset.action;if(!s){console.error("No action found on button:",t);return}const n=document.getElementById("swift_csv_pro_license_key_input"),u=n?n.value:"",l=t.closest("div")?t.closest("div").querySelector(".spinner"):null;if(!u&&s==="activate"){alert(__("Please enter a license key.","swift-csv-pro"));return}t.disabled=!0,l&&(l.style.visibility="visible");try{const o=await wpPost("swift_csv_pro_manage_license",{nonce:swiftCSV.nonce,license_key:u,license_action:s});if(!o.success)throw new Error(o.data?.message||__("License operation failed.","swift-csv-pro"));location.reload()}catch(o){console.error("License error:",o),alert(o.message||__("An error occurred while processing your request. Please try again.","swift-csv-pro"))}finally{t.disabled=!1,l&&(l.style.visibility="hidden")}});
