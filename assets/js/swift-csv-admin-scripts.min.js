function __(e,o="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,o):e}document.addEventListener("DOMContentLoaded",function(){initLoggingSystem();const e=document.querySelectorAll('input[name="export_scope"]'),o=document.getElementById("custom-export-help");e.length&&o&&e.forEach(l=>{l.addEventListener("change",function(){o.style.display=this.value==="custom"?"block":"none"})}),initFileUpload();const r=document.querySelector("#swift-csv-ajax-export-form");r&&r.addEventListener("submit",handleAjaxExport);const i=document.querySelector("#swift-csv-ajax-import-form");i&&i.addEventListener("submit",handleAjaxImport),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),o=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),o&&(o.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,o="info",r="export"){const i=document.querySelector(`#${r}-log-content`);if(!i)return;const l=document.createElement("div");l.className=`log-entry log-${o}`;const c=new Date().toLocaleTimeString();l.textContent=`[${c}] ${e}`,i.appendChild(l),i.scrollTop=i.scrollHeight;const t=100,n=i.querySelectorAll(".log-entry");n.length>t&&n[0].remove()}function clearLog(e="export"){const o=document.querySelector(`#${e}-log-content`);o&&(o.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),o=document.querySelector("#ajax_csv_file"),r=document.querySelector("#csv-file-info"),i=document.querySelector("#remove-file-btn");if(!e||!o)return;if(e.dataset.swiftCsvInitialized==="true"){console.log("File upload already initialized, skipping");return}e.dataset.swiftCsvInitialized="true",console.log("Initializing file upload functionality"),o.addEventListener("change",t=>{t.target.files.length>0&&c(t.target.files[0])});let l=!1;e.addEventListener("click",function(t){if(l){console.log("Click already in progress, ignoring");return}l=!0,console.log("Upload area clicked"),setTimeout(()=>{try{o.click(),console.log("fileInput.click() executed successfully")}catch(n){console.error("Error calling fileInput.click():",n)}finally{setTimeout(()=>{l=!1},100)}},0)},!1),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");const n=t.dataTransfer.files;n.length>0&&c(n[0])}),i&&i.addEventListener("click",()=>{o.value="",e.style.display="block",r.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")});function c(t){if(!t.name.toLowerCase().endsWith(".csv")){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const n=10*1024*1024;if(t.size>n){addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");return}const u=r.querySelector(".file-name");u&&(u.textContent=t.name),e.style.display="none",r.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+t.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const o=document.querySelector("#ajax_export_post_type")?.value,r=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",i=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",l=document.querySelector("#export_limit")?.value||"";addLogEntry(swiftCSV.messages.postTypeExport+" "+o,"debug","export");const c=r==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+c,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(i==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(l||swiftCSV.messages.noLimit),"debug","export");const t=document.querySelector("#ajax-export-csv-btn"),n=document.querySelector("#ajax-export-cancel-btn"),u=Date.now();let a=!1;t&&(t.disabled=!0,t.value=swiftCSV.messages.exporting),n&&(n.style.display="inline-block");const p=document.querySelector("#export-download-btn");p&&(p.classList.remove("enabled"),p.href="#",p.removeAttribute("download"));let f="";n&&n.addEventListener("click",function(){a=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),n&&(n.style.display="none")});function d(m=0){if(a)return;addLogEntry(swiftCSV.messages.processingChunk+" "+m,"debug","import");const g=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:o,export_scope:r,include_private_meta:i,export_limit:l,start_row:m});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:g}).then(s=>s.json()).then(s=>{if(!s.success)throw new Error(s.data||"Export failed");if(s.csv_chunk&&(f+=s.csv_chunk),updateAjaxProgress(s,u),s.processed&&s.total){const S=Math.round(s.processed/s.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+s.processed+"/"+s.total+" ("+S+"%)","info","export")}s.continue&&!a?setTimeout(()=>d(s.processed),100):completeAjaxExport(f,t,n,o)}).catch(s=>{console.error("Export error:",s),addLogEntry(swiftCSV.messages.exportError+" "+s.message,"error","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),n&&(n.style.display="none")})}d()}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(swiftCSV.messages.startingImport,"info","import");const o=document.querySelector("#ajax_csv_file"),r=document.querySelector("#ajax_post_type")?.value,i=document.querySelector("#ajax_update_existing")?.checked;if(!o||!o.files.length){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const l=o.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+l.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(l.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+r,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(i?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const c=new FormData;c.append("action","swift_csv_ajax_import"),c.append("nonce",swiftCSV.nonce),c.append("csv_file",l),c.append("post_type",r),c.append("update_existing",i?"1":"0");const t=e.target.querySelector('button[type="submit"]'),n=document.querySelector("#ajax-import-cancel-btn"),u=Date.now();let a=!1;t&&(t.disabled=!0,t.textContent=swiftCSV.messages.importing),n&&(n.style.display="inline-block"),n&&n.addEventListener("click",function(){a=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),n&&(n.style.display="none")});function p(f=0,d=0,m=0,g=0){a||(addLogEntry(swiftCSV.messages.processingChunk+" "+f,"debug","import"),c.set("start_row",f),c.set("cumulative_created",d),c.set("cumulative_updated",m),c.set("cumulative_errors",g),fetch(swiftCSV.ajaxUrl,{method:"POST",body:c}).then(s=>s.json()).then(s=>{if(!s.success)throw new Error(s.data||"Import failed");if(updateImportProgress(s,u),s.processed&&s.total){const S=Math.round(s.processed/s.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+s.processed+"/"+s.total+" ("+S+"%)","info","import")}s.cumulative_created!==void 0&&addLogEntry(swiftCSV.messages.createdInfo+" "+s.cumulative_created,"success","import"),s.cumulative_updated!==void 0&&addLogEntry(swiftCSV.messages.updatedInfo+" "+s.cumulative_updated,"success","import"),s.cumulative_errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+s.cumulative_errors,"warning","import"),s.continue&&!a?setTimeout(()=>p(s.processed,s.cumulative_created,s.cumulative_updated,s.cumulative_errors),100):completeAjaxImport(s,t,n)}).catch(s=>{console.error("Import error:",s),addLogEntry(swiftCSV.messages.importError+" "+s.message,"error","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),n&&(n.style.display="none")}))}p()}function formatFileSize(e){if(e===0)return"0 Bytes";const o=1024,r=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,i)).toFixed(2))+" "+r[i]}function updateAjaxProgress(e,o){const r=document.querySelector(".swift-csv-progress");if(!r){console.warn("Progress container not found");return}const i=r.querySelector(".progress-bar-fill"),l=r.querySelector(".processed-rows"),c=r.querySelector(".total-rows"),t=r.querySelector(".percentage");i&&e.progress!==void 0&&(i.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress)}function updateImportProgress(e,o){const r=document.querySelector(".swift-csv-progress");if(!r){console.warn("Progress container not found");return}const i=r.querySelector(".progress-bar-fill"),l=r.querySelector(".processed-rows"),c=r.querySelector(".total-rows"),t=r.querySelector(".percentage"),n=r.querySelector(".created-count"),u=r.querySelector(".updated-count"),a=r.querySelector(".error-count");i&&e.progress!==void 0&&(i.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress),n&&e.cumulative_created!==void 0&&(n.textContent=e.cumulative_created),u&&e.cumulative_updated!==void 0&&(u.textContent=e.cumulative_updated),a&&e.cumulative_errors!==void 0&&(a.textContent=e.cumulative_errors)}function completeAjaxExport(e,o,r,i){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const l=new Blob([e],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(l),t=new Date,n=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0")+"_"+String(t.getHours()).padStart(2,"0")+"-"+String(t.getMinutes()).padStart(2,"0")+"-"+String(t.getSeconds()).padStart(2,"0"),u=`swiftcsv_export_${i}_${n}.csv`,a=document.querySelector("#export-download-btn");a&&(a.href=c,a.download=u,a.classList.add("enabled")),o&&(o.disabled=!1,o.value=swiftCSV.messages.exportCsv),r&&(r.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+u,"info","export")}function completeAjaxImport(e,o,r){addLogEntry(swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0&&addLogEntry(swiftCSV.messages.totalImported+" "+e.cumulative_created,"success","import"),e.cumulative_updated!==void 0&&addLogEntry(swiftCSV.messages.totalUpdated+" "+e.cumulative_updated,"success","import"),e.cumulative_errors!==void 0&&addLogEntry(swiftCSV.messages.totalErrors+" "+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import"),o&&(o.disabled=!1,o.textContent=swiftCSV.messages.startImport),r&&(r.style.display="none");const i=document.querySelector("#ajax_csv_file"),l=document.querySelector("#csv-file-upload"),c=document.querySelector("#csv-file-info");i&&(i.value=""),l&&(l.style.display="block"),c&&(c.style.display="none")}function startBatchExport(e,o){console.warn("startBatchExport is deprecated. Use AJAX export instead.")}
