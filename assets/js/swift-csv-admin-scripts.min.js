function __(e,t="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,t):e}function swiftCSVLog(e,t="info"){if(window.swiftCSV&&window.swiftCSV.debug){const o=(new Date).toISOString(),s=`[Swift CSV] ${e}`;switch(t){case"warn":console.warn(s,o);break;case"error":console.error(s,o);break;default:console.log(s,o)}}}function initLoggingSystem(){const e=document.querySelector("#export-log-content"),t=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),t&&(t.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,t="info",o="export"){const s=document.querySelector(`#${o}-log-content`);if(!s)return;const r=document.createElement("div");r.className=`log-entry log-${t}`;const n=(new Date).toLocaleTimeString();r.textContent=`[${n}] ${e}`,s.appendChild(r),s.scrollTop=s.scrollHeight;const a=s.querySelectorAll(".log-entry");a.length>100&&a[0].remove()}function clearLog(e="export"){const t=document.querySelector(`#${e}-log-content`);t&&(t.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),t=document.querySelector("#ajax_csv_file"),o=document.querySelector("#csv-file-info"),s=document.querySelector("#remove-file-btn");if(!e||!t)return;if("true"===e.dataset.swiftCsvInitialized)return;e.dataset.swiftCsvInitialized="true",t.addEventListener("change",e=>{e.target.files.length>0&&n(e.target.files[0])});let r=!1;function n(t){if(!t.name.toLowerCase().endsWith(".csv"))return void addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");const s=10485760;if(t.size>s)return swiftCSVLog(`File size validation failed: ${t.size} bytes exceeds 10485760 bytes`,"warn"),void addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");swiftCSVLog(`File selected: ${t.name} (${t.size} bytes)`);const r=o.querySelector(".file-name");r&&(r.textContent=t.name),e.style.display="none",o.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+t.name,"success","import")}e.addEventListener("click",function(e){r||(r=!0,setTimeout(()=>{try{t.click()}catch(e){console.error("Error calling fileInput.click():",e)}finally{setTimeout(()=>{r=!1},100)}},0))},!1),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");const o=t.dataTransfer.files;o.length>0&&n(o[0])}),s&&s.addEventListener("click",()=>{t.value="",e.style.display="block",o.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")})}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const t=document.querySelector("#ajax_export_post_type")?.value,o=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",s=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",r=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",n=document.querySelector("#export_limit")?.value||"";addLogEntry(swiftCSV.messages.postTypeExport+" "+t,"debug","export");const a="basic"===o?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+a,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+("1"===s?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(n||swiftCSV.messages.noLimit),"debug","export");const i=document.querySelector("#ajax-export-csv-btn"),d=document.querySelector("#ajax-export-cancel-btn"),c=Date.now();let l=!1;i&&(i.disabled=!0,i.value=swiftCSV.messages.exporting),d&&(d.style.display="inline-block");const u=document.querySelector("#export-download-btn");u&&(u.classList.remove("enabled"),u.href="#",u.removeAttribute("download"));let p="";d&&d.addEventListener("click",function(){l=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),i&&(i.disabled=!1,i.value=swiftCSV.messages.exportCsv),d&&(d.style.display="none")}),function e(a=0){if(l)return;addLogEntry(swiftCSV.messages.processingChunk+" "+a,"debug","import");const u=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:t,export_scope:o,include_private_meta:s,taxonomy_format:r,export_limit:n,start_row:a});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:u}).then(e=>e.json()).then(o=>{if(!o.success)throw new Error(o.data||"Export failed");if(o.csv_chunk&&(p+=o.csv_chunk),updateAjaxProgress(o,c),o.processed&&o.total){const e=Math.round(o.processed/o.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+o.processed+"/"+o.total+" ("+e+"%)","info","export")}o.continue&&!l?setTimeout(()=>e(o.processed),100):completeAjaxExport(p,i,d,t)}).catch(e=>{console.error("Export error:",e),addLogEntry(swiftCSV.messages.exportError+" "+e.message,"error","export"),i&&(i.disabled=!1,i.value=swiftCSV.messages.exportCsv),d&&(d.style.display="none")})}()}function handleAjaxImport(e){e.preventDefault(),clearLog("import");const t=document.querySelector("#ajax_csv_file"),o=document.querySelector("#ajax_post_type")?.value,s=document.querySelector("#ajax_update_existing")?.checked,r=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",n=document.querySelector("#dry_run")?.checked||!1;if(n&&addLogEntry("[Dry Run] "+swiftCSV.messages.dryRunNotice,"info","import"),addLogEntry(swiftCSV.messages.startingImport,"info","import"),!t||!t.files.length)return void addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");const a=t.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+a.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(a.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+o,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(s?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const i=new FormData;i.append("action","swift_csv_ajax_import"),i.append("nonce",swiftCSV.nonce),i.append("csv_file",a),i.append("post_type",o),i.append("update_existing",s?"1":"0"),i.append("taxonomy_format",r),i.append("dry_run",n?"1":"0");const d=e.target.querySelector('button[type="submit"]'),c=document.querySelector("#ajax-import-cancel-btn"),l=Date.now();let u=!1;swiftCSVLog(`Import started: post_type=${o}, update_existing=${s}, taxonomy_format=${r}, dry_run=${n}`),d&&(d.disabled=!0,d.textContent=swiftCSV.messages.importing),c&&(c.style.display="inline-block"),c&&c.addEventListener("click",function(){u=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),d&&(d.disabled=!1,d.textContent=swiftCSV.messages.startImport),c&&(c.style.display="none")}),function e(t=0,o=0,s=0,r=0){u||(addLogEntry(swiftCSV.messages.processingChunk+" "+t,"debug","import"),i.set("start_row",t),i.set("cumulative_created",o),i.set("cumulative_updated",s),i.set("cumulative_errors",r),fetch(swiftCSV.ajaxUrl,{method:"POST",body:i}).then(e=>e.json()).then(t=>{if(!t.success)throw new Error(t.error||"Import failed");if(updateImportProgress(t,l),t.processed&&t.total){const e=Math.round(t.processed/t.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+t.processed+"/"+t.total+" ("+e+"%)","info","import")}if(n&&t.dry_run_log&&Array.isArray(t.dry_run_log)&&t.dry_run_log.length>0&&t.dry_run_log.forEach(e=>{e&&""!==e.trim()&&addLogEntry("[Dry Run] "+e,"info","import")}),void 0!==t.cumulative_created){addLogEntry((n?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.createdInfo)+" "+t.cumulative_created,"success","import")}if(void 0!==t.cumulative_updated){addLogEntry((n?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.updatedInfo)+" "+t.cumulative_updated,"info","import")}t.cumulative_errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+t.cumulative_errors,"warning","import"),t.continue&&!u?setTimeout(()=>e(t.processed,t.cumulative_created,t.cumulative_updated,t.cumulative_errors),100):completeAjaxImport(t,d,c)}).catch(e=>{console.error("Import error:",e);let t=e.message;"Import failed"===t&&e.message.includes("Format mismatch detected")&&(t=e.message),addLogEntry(swiftCSV.messages.importError+" "+t,"error","import"),d&&(d.disabled=!1,d.textContent=swiftCSV.messages.startImport),c&&(c.style.display="none")}))}()}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function updateAjaxProgress(e,t){const o=document.querySelector(".swift-csv-progress");if(!o)return void console.warn("Progress container not found");const s=o.querySelector(".progress-bar-fill"),r=o.querySelector(".processed-rows"),n=o.querySelector(".total-rows"),a=o.querySelector(".percentage");s&&void 0!==e.progress&&(s.style.width=e.progress+"%"),r&&void 0!==e.processed&&(r.textContent=e.processed),n&&void 0!==e.total&&(n.textContent=e.total),a&&void 0!==e.progress&&(a.textContent=e.progress)}function updateImportProgress(e,t){const o=document.querySelector(".swift-csv-progress");if(!o)return void console.warn("Progress container not found");const s=o.querySelector(".progress-bar-fill"),r=o.querySelector(".processed-rows"),n=o.querySelector(".total-rows"),a=o.querySelector(".percentage"),i=o.querySelector(".created-count"),d=o.querySelector(".updated-count"),c=o.querySelector(".error-count");s&&void 0!==e.progress&&(s.style.width=e.progress+"%"),r&&void 0!==e.processed&&(r.textContent=e.processed),n&&void 0!==e.total&&(n.textContent=e.total),a&&void 0!==e.progress&&(a.textContent=e.progress),i&&void 0!==e.cumulative_created&&(i.textContent=e.cumulative_created),d&&void 0!==e.cumulative_updated&&(d.textContent=e.cumulative_updated),c&&void 0!==e.cumulative_errors&&(c.textContent=e.cumulative_errors)}function completeAjaxExport(e,t,o,s){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const r=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),a=new Date,i=`swiftcsv_export_${s}_${a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0")+"_"+String(a.getHours()).padStart(2,"0")+"-"+String(a.getMinutes()).padStart(2,"0")+"-"+String(a.getSeconds()).padStart(2,"0")}.csv`,d=document.querySelector("#export-download-btn");d&&(d.href=n,d.download=i,d.classList.add("enabled")),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),o&&(o.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+i,"info","export")}function completeAjaxImport(e,t,o){const s=e.dry_run||!1;if(addLogEntry(s?"[Dry Run] "+swiftCSV.messages.dryRunCompleted:swiftCSV.messages.importCompleted,"success","import"),void 0!==e.cumulative_created){addLogEntry((s?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.totalImported+" ")+e.cumulative_created,"success","import")}if(void 0!==e.cumulative_updated){addLogEntry((s?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.totalUpdated+" ")+e.cumulative_updated,"success","import")}if(void 0!==e.cumulative_errors){addLogEntry((s?"[Dry Run] "+swiftCSV.messages.dryRunErrors+" ":swiftCSV.messages.totalErrors+" ")+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import")}t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),o&&(o.style.display="none");const r=document.querySelector("#ajax_csv_file"),n=document.querySelector("#csv-file-upload"),a=document.querySelector("#csv-file-info");r&&(r.value=""),n&&(n.style.display="block"),a&&(a.style.display="none")}document.addEventListener("DOMContentLoaded",function(){swiftCSVLog("JavaScript initialized"),initLoggingSystem();const e=document.querySelectorAll('input[name="export_scope"]'),t=document.getElementById("custom-export-help");e.length&&t&&(swiftCSVLog("Export scope toggle initialized"),e.forEach(e=>{e.addEventListener("change",function(){t.style.display="custom"===this.value?"block":"none"})})),initFileUpload();const o=document.querySelector("#swift-csv-ajax-export-form");o&&(swiftCSVLog("Ajax export form initialized"),o.addEventListener("submit",handleAjaxExport));const s=document.querySelector("#swift-csv-ajax-import-form");s&&(swiftCSVLog("Ajax import form initialized"),s.addEventListener("submit",handleAjaxImport)),initFileUpload()});