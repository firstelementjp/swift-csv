const{__}=window.wp.i18n||{__:e=>e};document.addEventListener("DOMContentLoaded",function(){initLoggingSystem();const e=document.querySelector("#export-csv-btn");e&&e.addEventListener("click",function(n){n.preventDefault();const i=document.querySelector("#post_type")?.value,t=document.querySelector("#posts_per_page")?.value;if(!i||!t||t<1){addLogEntry(__("An error occurred. Please try again.","swift-csv"),"error");return}startBatchExport(i,t)});const s=document.querySelector("#swift-csv-ajax-export-form");s&&s.addEventListener("submit",handleAjaxExport);const r=document.querySelector("#swift-csv-ajax-import-form");r&&r.addEventListener("submit",handleAjaxImport),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),s=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+__("Ready to start export...","swift-csv")+"</div>"),s&&(s.innerHTML='<div class="log-entry log-info">'+__("Ready to start import...","swift-csv")+"</div>")}function addLogEntry(e,s="info",r="export"){const n=document.querySelector(`#${r}-log-content`);if(!n)return;const i=document.createElement("div");i.className=`log-entry log-${s}`;const t=new Date().toLocaleTimeString();i.textContent=`[${t}] ${e}`,n.appendChild(i),n.scrollTop=n.scrollHeight;const o=100,l=n.querySelectorAll(".log-entry");l.length>o&&l[0].remove()}function clearLog(e="export"){const s=document.querySelector(`#${e}-log-content`);s&&(s.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),s=document.querySelector("#ajax_csv_file"),r=document.querySelector("#csv-file-info"),n=document.querySelector("#remove-file-btn");if(!e||!s)return;e.addEventListener("click",()=>{s.click()}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");const o=t.dataTransfer.files;o.length>0&&i(o[0])}),s.addEventListener("change",t=>{t.target.files.length>0&&i(t.target.files[0])}),n&&n.addEventListener("click",()=>{s.value="",e.style.display="block",r.style.display="none",addLogEntry(__("File removed","swift-csv"),"info","import")});function i(t){if(!t.name.toLowerCase().endsWith(".csv")){addLogEntry(__("Please select a CSV file","swift-csv"),"error","import");return}const o=10*1024*1024;if(t.size>o){addLogEntry(__("File size exceeds 10MB limit","swift-csv"),"error","import");return}const l=r.querySelector(".file-name");l&&(l.textContent=t.name),e.style.display="none",r.style.display="flex",addLogEntry(__("File selected:","swift-csv")+" "+t.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(__("Starting export process...","swift-csv"),"info","export");const s=document.querySelector("#ajax_export_post_type")?.value,r=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",n=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",i=document.querySelector("#export_limit")?.value||"";addLogEntry(__("Post Type:","swift-csv")+" "+s,"debug","export"),addLogEntry(__("Export Scope:","swift-csv")+" "+r,"debug","export"),addLogEntry(__("Include Private Meta:","swift-csv")+" "+__(n==="1"?"Yes":"No","swift-csv"),"debug","export"),addLogEntry(__("Export Limit:","swift-csv")+" "+(i||__("No limit","swift-csv")),"debug","export");const t=document.querySelector("#ajax-export-csv-btn"),o=document.querySelector("#ajax-export-cancel-btn"),l=Date.now();let u=!1;t&&(t.disabled=!0,t.value=__("Exporting...","swift-csv")),o&&(o.style.display="inline-block");let f="";o&&o.addEventListener("click",function(){u=!0,addLogEntry(__("Export cancelled by user","swift-csv"),"warning","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),o&&(o.style.display="none")});function d(a=0){if(u)return;addLogEntry(__("Processing chunk starting from row","swift-csv")+" "+a,"debug","export");const c=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:s,export_scope:r,include_private_meta:n,export_limit:i,start_row:a});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c}).then(p=>p.json()).then(p=>{if(!p.success)throw new Error(p.data||"Export failed");if(p.csv_chunk&&(f+=p.csv_chunk),updateAjaxProgress(p,l),p.processed&&p.total){const m=Math.round(p.processed/p.total*100);addLogEntry(__("Processed","swift-csv")+" "+p.processed+"/"+p.total+" ("+m+"%)","info","export")}p.continue&&!u?setTimeout(()=>d(p.processed),100):completeAjaxExport(f,t,o,s)}).catch(p=>{console.error("Export error:",p),addLogEntry(__("Export error:","swift-csv")+" "+p.message,"error","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),o&&(o.style.display="none")})}d()}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(__("Starting import process...","swift-csv"),"info","import");const s=document.querySelector("#ajax_csv_file"),r=document.querySelector("#ajax_post_type")?.value,n=document.querySelector("#ajax_update_existing")?.checked;if(!s||!s.files.length){addLogEntry(__("Please select a CSV file","swift-csv"),"error","import");return}const i=s.files[0];addLogEntry(__("File:","swift-csv")+" "+i.name,"debug","import"),addLogEntry(__("File Size:","swift-csv")+" "+formatFileSize(i.size),"debug","import"),addLogEntry(__("Post Type:","swift-csv")+" "+r,"debug","import"),addLogEntry(__("Update Existing:","swift-csv")+" "+__(n?"Yes":"No","swift-csv"),"debug","import");const t=new FormData;t.append("action","swift_csv_ajax_import"),t.append("nonce",swiftCSV.nonce),t.append("csv_file",i),t.append("post_type",r),t.append("update_existing",n?"1":"0");const o=e.target.querySelector('button[type="submit"]'),l=document.querySelector("#ajax-import-cancel-btn"),u=Date.now();let f=!1;o&&(o.disabled=!0,o.textContent=__("Importing...","swift-csv")),l&&(l.style.display="inline-block"),l&&l.addEventListener("click",function(){f=!0,addLogEntry(__("Import cancelled by user","swift-csv"),"warning","import"),o&&(o.disabled=!1,o.textContent=__("Start Import","swift-csv")),l&&(l.style.display="none")});function d(a=0){f||(addLogEntry(__("Processing chunk starting from row","swift-csv")+" "+a,"debug","import"),t.set("start_row",a),fetch(swiftCSV.ajaxUrl,{method:"POST",body:t}).then(c=>c.json()).then(c=>{if(!c.success)throw new Error(c.data||"Import failed");if(updateImportProgress(c,u),c.processed&&c.total){const p=Math.round(c.processed/c.total*100);addLogEntry(__("Processed","swift-csv")+" "+c.processed+"/"+c.total+" ("+p+"%)","info","import")}c.created!==void 0&&addLogEntry(__("Created:","swift-csv")+" "+c.created,"success","import"),c.updated!==void 0&&addLogEntry(__("Updated:","swift-csv")+" "+c.updated,"success","import"),c.errors>0&&addLogEntry(__("Errors:","swift-csv")+" "+c.errors,"warning","import"),c.continue&&!f?setTimeout(()=>d(c.processed),100):completeAjaxImport(c,o,l)}).catch(c=>{console.error("Import error:",c),addLogEntry(__("Import error:","swift-csv")+" "+c.message,"error","import"),o&&(o.disabled=!1,o.textContent=__("Start Import","swift-csv")),l&&(l.style.display="none")}))}d()}function formatFileSize(e){if(e===0)return"0 Bytes";const s=1024,r=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(s));return parseFloat((e/Math.pow(s,n)).toFixed(2))+" "+r[n]}function updateAjaxProgress(e,s){const r=document.querySelector(".swift-csv-progress");if(!r){console.warn("Progress container not found");return}const n=r.querySelector(".progress-bar-fill"),i=r.querySelector(".processed-rows"),t=r.querySelector(".total-rows"),o=r.querySelector(".percentage");n&&e.progress!==void 0&&(n.style.width=e.progress+"%"),i&&e.processed!==void 0&&(i.textContent=e.processed),t&&e.total!==void 0&&(t.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress)}function updateImportProgress(e,s){const r=document.querySelector(".swift-csv-progress");if(!r){console.warn("Progress container not found");return}const n=r.querySelector(".progress-bar-fill"),i=r.querySelector(".processed-rows"),t=r.querySelector(".total-rows"),o=r.querySelector(".percentage"),l=r.querySelector(".created-count"),u=r.querySelector(".updated-count"),f=r.querySelector(".error-count");n&&e.progress!==void 0&&(n.style.width=e.progress+"%"),i&&e.processed!==void 0&&(i.textContent=e.processed),t&&e.total!==void 0&&(t.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress),l&&e.created!==void 0&&(l.textContent=e.created),u&&e.updated!==void 0&&(u.textContent=e.updated),f&&e.errors!==void 0&&(f.textContent=e.errors)}function completeAjaxExport(e,s,r,n){addLogEntry(__("Export completed successfully!","swift-csv"),"success","export");const i=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(i),o=new Date,l=o.getFullYear()+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0")+"_"+String(o.getHours()).padStart(2,"0")+"-"+String(o.getMinutes()).padStart(2,"0")+"-"+String(o.getSeconds()).padStart(2,"0"),u=`swiftcsv_export_${n}_${l}.csv`,f=document.querySelector("#ajax-export-download-link a");f&&(f.href=t,f.download=u,f.parentElement.style.display="block"),s&&(s.disabled=!1,s.value=swiftCSV.messages.exportCsv),r&&(r.style.display="none"),addLogEntry(__("Download ready:","swift-csv")+" "+u,"info","export")}function completeAjaxImport(e,s,r){addLogEntry(__("Import completed!","swift-csv"),"success","import"),e.imported!==void 0&&addLogEntry(__("Total imported:","swift-csv")+" "+e.imported,"success","import"),e.updated!==void 0&&addLogEntry(__("Total updated:","swift-csv")+" "+e.updated,"success","import"),e.errors!==void 0&&addLogEntry(__("Total errors:","swift-csv")+" "+e.errors,e.errors>0?"warning":"success","import"),s&&(s.disabled=!1,s.textContent=__("Start Import","swift-csv")),r&&(r.style.display="none");const n=document.querySelector("#ajax_csv_file"),i=document.querySelector("#csv-file-upload"),t=document.querySelector("#csv-file-info");n&&(n.value=""),i&&(i.style.display="block"),t&&(t.style.display="none")}function startBatchExport(e,s){addLogEntry(__("Batch export started","swift-csv"),"info","export")}
