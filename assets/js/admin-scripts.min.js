const{__}=window.wp.i18n||{__:t=>t};document.addEventListener("DOMContentLoaded",function(){const t=document.querySelector("#export-csv-btn");t&&t.addEventListener("click",function(r){r.preventDefault();const o=document.querySelector("#post_type")?.value,l=document.querySelector("#posts_per_page")?.value;if(!o||!l||l<1){alert(__("An error occurred. Please try again.","swift-csv"));return}startBatchExport(o,l)});const e=document.querySelector("#swift-csv-ajax-export-form");e&&e.addEventListener("submit",handleAjaxExport)});function handleAjaxExport(t){t.preventDefault();const e=document.querySelector("#ajax_export_post_type")?.value,r=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",o=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",l=document.querySelector("#export_limit")?.value||"",s=document.querySelector("#swift-csv-ajax-export-progress");if(!s){console.error("Progress element not found!");return}const n=document.querySelector("#ajax-export-csv-btn"),i=document.querySelector("#ajax-export-cancel-btn"),d=Date.now();let a=!1;s.style.display="block",n&&(n.disabled=!0,n.value=__("Exporting...","swift-csv")),i?(i.style.display="inline-block",console.log("Cancel button found and shown:",i)):console.log("Cancel button not found!");let f="";i&&i.addEventListener("click",function(){a=!0,n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),i&&(i.style.display="none");const u=s.querySelector(".progress-status");u&&(u.textContent=swiftCSV.messages.cancelled)});function p(u=0){if(a)return;const m=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:e,export_scope:r,include_private_meta:o,export_limit:l,start_row:u});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:m}).then(c=>c.json()).then(c=>{if(!c.success)throw new Error(c.data||"Export failed");c.csv_chunk&&(f+=c.csv_chunk),updateAjaxProgress(s,c,d),c.continue&&!a?setTimeout(()=>p(c.processed),100):completeAjaxExport(s,f,n,i,e)}).catch(c=>{console.error("Export error:",c);const x=s.querySelector(".progress-status");x&&(x.textContent=swiftCSV.messages.failed+": "+c.message),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv)})}p()}function updateAjaxProgress(t,e,r){const o=t.querySelector(".progress-bar-fill"),l=t.querySelector(".progress-text"),s=t.querySelector(".progress-processed"),n=t.querySelector(".progress-total"),i=t.querySelector(".progress-status"),d=t.querySelector(".progress-time");if(o&&(o.style.width=e.progress+"%"),l&&(l.textContent=e.progress+"%"),s&&(s.textContent=e.processed),n&&(n.textContent=e.total),i&&e.status&&(e.status==="completed"?i.textContent=swiftCSV.messages.completed:i.textContent=swiftCSV.messages.processing),d&&e.processed>0){const a=Date.now()-r,f=3;let p;e.processed>=f*50?p=e.processed/a:p=Math.min(e.processed/a,.002);const u=(e.total-e.processed)/p,m=Math.floor(a/6e4),c=Math.max(0,Math.floor(u/6e4));console.log("Time calculation debug:"),console.log("- Processed:",e.processed),console.log("- Total:",e.total),console.log("- Elapsed (ms):",a),console.log("- Rate:",p),console.log("- Remaining (ms):",u),console.log("- Elapsed minutes:",m),console.log("- Remaining minutes:",c);const x=t.querySelector(".progress-elapsed"),g=t.querySelector(".progress-remaining");x&&(x.textContent=m),g&&(g.textContent=c),console.log("Updated elapsed:",m,"remaining:",c)}}function completeAjaxExport(t,e,r,o,l){const s=t.querySelector(".progress-status"),n=document.querySelector("#ajax-export-download-link");if(s&&(s.textContent=swiftCSV.messages.completed),r&&(r.disabled=!1,r.value=swiftCSV.messages.exportCsv),o&&(o.style.display="none"),e&&n){const i=new Blob([e],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(i),a=n.querySelector("a");if(a){a.href=d;const f=new Date().toISOString().slice(0,19).replace(/[:-]/g,"");a.download=`swiftcsv_export_${l}_${f}.csv`}n.style.display="block"}}function startBatchExport(t,e){const r=document.querySelector("#export-csv-btn"),o=document.querySelector("#swift-csv-export-progress");r&&(r.disabled=!0,r.textContent=swiftCSV.messages.exporting),o&&(o.style.display="block");const l=new URLSearchParams({action:"swift_csv_start_export",post_type:t,posts_per_page:e,nonce:swiftCSV.nonce});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:l}).then(s=>s.json()).then(s=>{if(s.success)pollExportProgress(s.batch_id);else throw new Error(s.data||"Export failed")}).catch(s=>{console.error("Export error:",s),alert(swiftCSV.messages.error),resetExportButton()})}function pollExportProgress(t){const e=setInterval(()=>{const r=new URLSearchParams({action:"swift_csv_check_progress",batch_id:t,nonce:swiftCSV.nonce});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r}).then(o=>o.json()).then(o=>{if(o.success)updateExportProgress(o),o.status==="completed"?(clearInterval(e),showDownloadLink(o.download_url),resetExportButton()):o.status==="error"&&(clearInterval(e),alert(swiftCSV.messages.error),resetExportButton());else throw new Error(o.data||"Progress check failed")}).catch(o=>{console.error("Progress check error:",o),clearInterval(e),resetExportButton()})},2e3)}function updateExportProgress(t){const e=t.percentage||(t.total_rows>0?Math.round(t.processed_rows/t.total_rows*100):0),r=document.querySelector("#swift-csv-export-progress .progress-bar-fill"),o=document.querySelector("#swift-csv-export-progress .progress-text"),l=document.querySelector("#swift-csv-export-progress .processed-rows"),s=document.querySelector("#swift-csv-export-progress .total-rows");r&&(r.style.width=e+"%"),o&&(o.textContent=e+"%"),l&&(l.textContent=t.processed_rows),s&&(s.textContent=t.total_rows)}function showDownloadLink(t){const e=document.querySelector("#export-download-link");if(e){const r=e.querySelector("a");r&&(r.href=t),e.style.display="block"}}function resetExportButton(){const t=document.querySelector("#export-csv-btn");t&&(t.disabled=!1,t.textContent=swiftCSV.messages.exportCsv)}
