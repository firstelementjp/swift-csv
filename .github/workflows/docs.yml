name: Generate Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: dom, xml
          coverage: none
          
      - name: Install dependencies
        run: composer install --no-progress --no-interaction

      - name: Generate simple documentation
        run: |
          mkdir -p docs/api
          echo '<!DOCTYPE html>' > docs/api/index.html
          echo '<html><head>' >> docs/api/index.html
          echo '<title>Swift CSV API Documentation</title>' >> docs/api/index.html
          echo '<meta charset="UTF-8">' >> docs/api/index.html
          echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> docs/api/index.html
          echo '<style>' >> docs/api/index.html
          echo 'body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; }' >> docs/api/index.html
          echo 'h1 { color: #2c3e50; text-align: center; }' >> docs/api/index.html
          echo 'h2 { color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }' >> docs/api/index.html
          echo 'h3 { color: #2980b9; }' >> docs/api/index.html
          echo '.method { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #3498db; }' >> docs/api/index.html
          echo '.method-name { color: #2c3e50; font-size: 18px; font-weight: bold; margin-bottom: 10px; }' >> docs/api/index.html
          echo '.signature { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }' >> docs/api/index.html
          echo '.params { margin: 15px 0; }' >> docs/api/index.html
          echo '.param { margin: 5px 0; }' >> docs/api/index.html
          echo '.param-name { font-weight: bold; color: #2980b9; }' >> docs/api/index.html
          echo '.param-type { color: #27ae60; font-family: monospace; }' >> docs/api/index.html
          echo '.returns { background: #d5f4e6; padding: 10px; border-radius: 4px; margin: 10px 0; }' >> docs/api/index.html
          echo '.description { color: #7f8c8d; font-style: italic; margin: 10px 0; }' >> docs/api/index.html
          echo '.toc { background: #ecf0f1; padding: 20px; border-radius: 8px; margin: 20px 0; }' >> docs/api/index.html
          echo '.toc ul { list-style: none; padding-left: 0; }' >> docs/api/index.html
          echo '.toc li { margin: 5px 0; }' >> docs/api/index.html
          echo '.toc a { text-decoration: none; color: #2980b9; }' >> docs/api/index.html
          echo '.toc a:hover { text-decoration: underline; }' >> docs/api/index.html
          echo '</meta></head><body>' >> docs/api/index.html
          echo '<h1>üöÄ Swift CSV API Documentation</h1>' >> docs/api/index.html
          echo '<p><strong>Version:</strong> 0.9.1 | <strong>Generated on:</strong> '"$(date)"'</p>' >> docs/api/index.html
          
          # Table of Contents
          echo '<div class="toc">' >> docs/api/index.html
          echo '<h2>üìã Table of Contents</h2>' >> docs/api/index.html
          echo '<ul>' >> docs/api/index.html
          
          for file in includes/*.php; do
            if [ -f "$file" ]; then
              classname=$(basename "$file" .php)
              echo '<li><a href="#'"$classname"'">'"$classname"'</a></li>' >> docs/api/index.html
            fi
          done
          
          echo '</ul></div>' >> docs/api/index.html
          
          for file in includes/*.php; do
            if [ -f "$file" ]; then
              classname=$(basename "$file" .php)
              echo '<h2 id="'"$classname"'">üèóÔ∏è '"$classname"'</h2>' >> docs/api/index.html
              
              # Extract class description
              class_desc=$(grep -A 5 "class $classname" "$file" | grep -E "/\*\*|/\*" | head -1 | sed 's/\/\*\*//' | sed 's/\/\*//' | sed 's/\*//' | xargs)
              if [ ! -z "$class_desc" ]; then
                echo '<div class="description">'"$class_desc"'</div>' >> docs/api/index.html
              fi
              
              # Extract methods with details
              grep -n "public function" "$file" | while read line; do
                linenum=$(echo "$line" | cut -d: -f1)
                method_line=$(echo "$line" | cut -d: -f2-)
                method=$(echo "$method_line" | sed 's/.*public function //' | sed 's/(.*$//')
                
                echo '<div class="method">' >> docs/api/index.html
                echo '<div class="method-name">'"$method"'</div>' >> docs/api/index.html
                
                # Get method signature
                signature=$(sed -n "${linenum}p" "$file" | sed 's/^[[:space:]]*//')
                echo '<div class="signature">'"$signature"'</div>' >> docs/api/index.html
                
                # Extract PHPDoc comments (5 lines before method)
                start_line=$((linenum - 5))
                if [ $start_line -lt 1 ]; then start_line=1; fi
                end_line=$((linenum - 1))
                
                phpdoc=$(sed -n "${start_line},${end_line}p" "$file" | grep -E "@param|@return|@throws|@brief|@desc" | head -10)
                if [ ! -z "$phpdoc" ]; then
                  echo '<div class="params">' >> docs/api/index.html
                  echo "$phpdoc" | while read doc_line; do
                    if [[ "$doc_line" == *"@param"* ]]; then
                      param=$(echo "$doc_line" | sed 's/.*@param //' | sed 's/^[[:space:]]*//')
                      param_name=$(echo "$param" | awk '{print $1}')
                      param_type=$(echo "$param" | awk '{print $2}')
                      param_desc=$(echo "$param" | cut -d' ' -f3-)
                      echo '<div class="param"><span class="param-name">'"$param_name"'</span> <span class="param-type">('"$param_type"')</span>: '"$param_desc"'</div>' >> docs/api/index.html
                    elif [[ "$doc_line" == *"@return"* ]]; then
                      return_val=$(echo "$doc_line" | sed 's/.*@return //' | sed 's/^[[:space:]]*//')
                      echo '<div class="returns"><strong>Returns:</strong> '"$return_val"'</div>' >> docs/api/index.html
                    fi
                  done
                  echo '</div>' >> docs/api/index.html
                fi
                
                echo '</div>' >> docs/api/index.html
              done
            fi
          done
          
          echo '<div style="margin-top: 50px; text-align: center; color: #7f8c8d;">' >> docs/api/index.html
          echo '<p>üìñ For more details, visit the <a href="https://github.com/firstelementjp/swift-csv">GitHub repository</a></p>' >> docs/api/index.html
          echo '</div>' >> docs/api/index.html
          echo '</body></html>' >> docs/api/index.html

      - name: Generate README documentation
        run: |
          echo "## üìã Recent Changes" > docs/changelog.md
          git log --oneline --since="1 month ago" >> docs/changelog.md
          
          echo "## üèóÔ∏è Class Structure" >> docs/overview.md
          find includes/ -name "*.php" -exec basename {} .php \; | sort | sed 's/^/- /' >> docs/overview.md
          
      - name: Generate root index page
        run: |
          echo '<!DOCTYPE html>' > docs/index.html
          echo '<html><head>' >> docs/index.html
          echo '<title>Swift CSV - WordPress Plugin</title>' >> docs/index.html
          echo '<meta charset="UTF-8">' >> docs/index.html
          echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> docs/index.html
          echo '<style>' >> docs/index.html
          echo 'body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; }' >> docs/index.html
          echo 'h1 { color: #2c3e50; text-align: center; }' >> docs/index.html
          echo 'h2 { color: #34495e; }' >> docs/index.html
          echo '.card { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #3498db; }' >> docs/index.html
          echo '.btn { display: inline-block; background: #3498db; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; margin: 10px 5px; }' >> docs/index.html
          echo '.btn:hover { background: #2980b9; }' >> docs/index.html
          echo '.center { text-align: center; margin: 30px 0; }' >> docs/index.html
          echo '</style></head><body>' >> docs/index.html
          echo '<h1>üöÄ Swift CSV</h1>' >> docs/index.html
          echo '<div class="center">' >> docs/index.html
          echo '<p><strong>WordPress CSV Import/Export Plugin</strong></p>' >> docs/index.html
          echo '<p>Generated on: '"$(date)"'</p>' >> docs/index.html
          echo '</div>' >> docs/index.html
          echo '<div class="card">' >> docs/index.html
          echo '<h2>üìö Documentation</h2>' >> docs/index.html
          echo '<p><a href="/swift-csv/api/" class="btn">üìñ API Documentation</a></p>' >> docs/index.html
          echo '<p><a href="/swift-csv/overview.md" class="btn">üèóÔ∏è Class Structure</a></p>' >> docs/index.html
          echo '<p><a href="/swift-csv/changelog.md" class="btn">üìã Recent Changes</a></p>' >> docs/index.html
          echo '</div>' >> docs/index.html
          echo '<div class="card">' >> docs/index.html
          echo '<h2>‚¨áÔ∏è Download</h2>' >> docs/index.html
          echo '<p><a href="https://github.com/firstelementjp/swift-csv/releases/latest" class="btn">üì¶ Latest Release</a></p>' >> docs/index.html
          echo '<p><a href="https://github.com/firstelementjp/swift-csv" class="btn">üîß View Source Code</a></p>' >> docs/index.html
          echo '</div>' >> docs/index.html
          echo '</body></html>' >> docs/index.html
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
