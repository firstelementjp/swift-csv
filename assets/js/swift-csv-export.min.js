function handleAjaxExport(t){t.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const l=document.querySelector(".swift-csv-progress");if(l){const a=l.querySelector(".progress-bar");a&&(a.classList.add("processing"),a.classList.remove("completed"))}const s=document.querySelector("#ajax_export_post_type")?.value,n=document.querySelector('input[name="swift_csv_export_post_status"]:checked')?.value||"publish",w=document.querySelector('input[name="swift_csv_export_scope"]:checked')?.value||"basic",p=document.querySelector('input[name="swift_csv_include_private_meta"]')?.checked?"1":"0",o=document.querySelector('input[name="swift_csv_export_taxonomy_format"]:checked')?.value||"name",d=document.querySelector("#swift_csv_export_limit")?.value||"",S=(Date.now().toString(36)+Math.random().toString(36).slice(2)).replace(/\./g,"");addLogEntry(swiftCSV.messages.postTypeExport+" "+s,"debug","export");const f=w==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportContent+" "+f,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(p==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(d||swiftCSV.messages.noLimit),"debug","export");const i=document.querySelector("#ajax-export-csv-btn"),c=document.querySelector("#ajax-export-cancel-btn"),V=Date.now();let _=!1;i&&(i.disabled=!0,i.value=swiftCSV.messages.exporting),c&&(c.style.display="inline-block");const u=document.querySelector("#export-download-btn");u&&(u.classList.remove("enabled"),u.href="#",u.removeAttribute("download"));let m="",g=null,x=null;c&&(x&&c.removeEventListener("click",x),x=function(){_=!0,window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),g&&g.abort();const a=new URLSearchParams({action:"swift_csv_cancel_export",nonce:swiftCSV.nonce,export_session:S});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a}).catch(()=>{}),i&&(i.disabled=!1,i.value=swiftCSV.messages.exportCsv),c&&(c.style.display="none")},c.addEventListener("click",x,{once:!0}));function v(a=0){if(_)return;g=new AbortController,SwiftCSVCore.swiftCSVLog(swiftCSV.messages.processingChunk+" "+a,"debug");const L=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:s,post_status:n,export_scope:w,include_private_meta:p,taxonomy_format:o,export_limit:d,start_row:a,export_session:S});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:L,signal:g.signal}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{if(e.success&&e.continue)m+=e.csv_chunk,updateAjaxProgress(e,V),e.export_details&&Array.isArray(e.export_details)&&e.export_details.length>0&&e.export_details.forEach(r=>{const C=r.status==="success"?"\u2713":"\u2717",y=`${`[${swiftCSV.messages.exportPrefix||"Export"}]`} ${C} ${swiftCSV.messages.rowLabel||"Row"} ${r.row}: ${r.title}`;window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(y,r.status==="success"?"success":"error","export")}),v(e.processed);else if(e.success)updateAjaxProgress(e,V),e.export_details&&Array.isArray(e.export_details)&&e.export_details.length>0&&e.export_details.forEach(r=>{const C=r.status==="success"?"\u2713":"\u2717",y=`${`[${swiftCSV.messages.exportPrefix||"Export"}]`} ${C} ${swiftCSV.messages.rowLabel||"Row"} ${r.row}: ${r.title}`;window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(y,r.status==="success"?"success":"error","export")}),m+=e.csv_chunk,completeAjaxExport(m,i,c,s);else{const r=(e&&e.data?e.data:"")||(e&&e.message?e.message:"")||"";throw new Error(r||swiftCSV.messages.exportError)}}).catch(e=>{e&&e.name==="AbortError"||(window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportError+" "+e.message,"error","export"),i&&(i.disabled=!1,i.value=swiftCSV.messages.exportCsv),c&&(c.style.display="none"))})}v()}function updateAjaxProgress(t,l){const s=document.querySelector(".swift-csv-progress");if(!s){window.SwiftCSVCore&&window.SwiftCSVCore.swiftCSVLog&&window.SwiftCSVCore.swiftCSVLog("Progress container not found");return}const n=s.querySelector(".progress-bar"),w=s.querySelector(".progress-bar-fill"),p=s.querySelector(".processed-rows"),o=s.querySelector(".total-rows"),d=s.querySelector(".percentage");n&&t.status==="processing"?(n.classList.add("processing"),n.classList.remove("completed")):n&&t.status==="completed"&&(n.classList.remove("processing"),n.classList.add("completed")),w&&t.progress!==void 0&&(w.style.width=t.progress+"%"),p&&t.processed!==void 0&&(p.textContent=t.processed),o&&t.total!==void 0&&(o.textContent=t.total),d&&t.progress!==void 0&&(d.textContent=t.progress)}function completeAjaxExport(t,l,s,n){window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const w=new Blob([t],{type:"text/csv;charset=utf-8;"}),p=URL.createObjectURL(w),o=new Date,d=String(o.getFullYear())+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0")+"-"+String(o.getHours()).padStart(2,"0")+"-"+String(o.getMinutes()).padStart(2,"0")+"-"+String(o.getSeconds()).padStart(2,"0"),S=`swiftcsv_export_${n}_${d}.csv`,f=document.querySelector("#export-download-btn");f&&(f.href=p,f.download=S,f.classList.add("enabled")),l&&(l.disabled=!1,l.value=swiftCSV.messages.startExport),s&&(s.style.display="none"),window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.downloadReady+" "+S,"info","export")}window.SwiftCSVExport={handleAjaxExport,updateAjaxProgress,completeAjaxExport};
