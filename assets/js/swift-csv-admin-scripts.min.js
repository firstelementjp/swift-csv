function __(e,o="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,o):e}function swiftCSVLog(e,o="info"){if(window.swiftCSV&&window.swiftCSV.debug){const s=new Date().toISOString(),r=`[Swift CSV] ${e}`;switch(o){case"warn":console.warn(r,s);break;case"error":console.error(r,s);break;default:console.log(r,s)}}}document.addEventListener("DOMContentLoaded",function(){swiftCSVLog("JavaScript initialized"),initLoggingSystem();const e=document.querySelectorAll('input[name="export_scope"]'),o=document.getElementById("custom-export-help");e.length&&o&&(swiftCSVLog("Export scope toggle initialized"),e.forEach(l=>{l.addEventListener("change",function(){o.style.display=this.value==="custom"?"block":"none"})})),initFileUpload();const s=document.querySelector("#swift-csv-ajax-export-form");s&&(swiftCSVLog("Ajax export form initialized"),s.addEventListener("submit",handleAjaxExport));const r=document.querySelector("#swift-csv-ajax-import-form");r&&(swiftCSVLog("Ajax import form initialized"),r.addEventListener("submit",handleAjaxImport)),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),o=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),o&&(o.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,o="info",s="export"){const r=document.querySelector(`#${s}-log-content`);if(!r)return;const l=document.createElement("div");l.className=`log-entry log-${o}`;const i=new Date().toLocaleTimeString();l.textContent=`[${i}] ${e}`,r.appendChild(l),r.scrollTop=r.scrollHeight;const t=100,n=r.querySelectorAll(".log-entry");n.length>t&&n[0].remove()}function clearLog(e="export"){const o=document.querySelector(`#${e}-log-content`);o&&(o.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),o=document.querySelector("#ajax_csv_file"),s=document.querySelector("#csv-file-info"),r=document.querySelector("#remove-file-btn");if(!e||!o||e.dataset.swiftCsvInitialized==="true")return;e.dataset.swiftCsvInitialized="true",o.addEventListener("change",t=>{t.target.files.length>0&&i(t.target.files[0])});let l=!1;e.addEventListener("click",function(t){l||(l=!0,setTimeout(()=>{try{o.click()}catch(n){console.error("Error calling fileInput.click():",n)}finally{setTimeout(()=>{l=!1},100)}},0))},!1),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");const n=t.dataTransfer.files;n.length>0&&i(n[0])}),r&&r.addEventListener("click",()=>{o.value="",e.style.display="block",s.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")});function i(t){if(!t.name.toLowerCase().endsWith(".csv")){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const n=10*1024*1024;if(t.size>n){swiftCSVLog(`File size validation failed: ${t.size} bytes exceeds ${n} bytes`,"warn"),addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");return}swiftCSVLog(`File selected: ${t.name} (${t.size} bytes)`);const a=s.querySelector(".file-name");a&&(a.textContent=t.name),e.style.display="none",s.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+t.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const o=document.querySelector("#ajax_export_post_type")?.value,s=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",r=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",l=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",i=document.querySelector("#export_limit")?.value||"";addLogEntry(swiftCSV.messages.postTypeExport+" "+o,"debug","export");const t=s==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+t,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(r==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(i||swiftCSV.messages.noLimit),"debug","export");const n=document.querySelector("#ajax-export-csv-btn"),a=document.querySelector("#ajax-export-cancel-btn"),p=Date.now();let d=!1;n&&(n.disabled=!0,n.value=swiftCSV.messages.exporting),a&&(a.style.display="inline-block");const f=document.querySelector("#export-download-btn");f&&(f.classList.remove("enabled"),f.href="#",f.removeAttribute("download"));let m="";a&&a.addEventListener("click",function(){d=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),a&&(a.style.display="none")});function g(S=0){if(d)return;addLogEntry(swiftCSV.messages.processingChunk+" "+S,"debug","import");const c=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:o,export_scope:s,include_private_meta:r,taxonomy_format:l,export_limit:i,start_row:S});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c}).then(u=>u.json()).then(u=>{if(!u.success)throw new Error(u.data||"Export failed");if(u.csv_chunk&&(m+=u.csv_chunk),updateAjaxProgress(u,p),u.processed&&u.total){const w=Math.round(u.processed/u.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+u.processed+"/"+u.total+" ("+w+"%)","info","export")}u.continue&&!d?setTimeout(()=>g(u.processed),100):completeAjaxExport(m,n,a,o)}).catch(u=>{console.error("Export error:",u),addLogEntry(swiftCSV.messages.exportError+" "+u.message,"error","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),a&&(a.style.display="none")})}g()}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(swiftCSV.messages.startingImport,"info","import");const o=document.querySelector("#ajax_csv_file"),s=document.querySelector("#ajax_post_type")?.value,r=document.querySelector("#ajax_update_existing")?.checked;if(!o||!o.files.length){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const l=o.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+l.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(l.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+s,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(r?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const i=new FormData;i.append("action","swift_csv_ajax_import"),i.append("nonce",swiftCSV.nonce),i.append("csv_file",l),i.append("post_type",s),i.append("update_existing",r?"1":"0");const t=e.target.querySelector('button[type="submit"]'),n=document.querySelector("#ajax-import-cancel-btn"),a=Date.now();let p=!1;swiftCSVLog(`Import started: post_type=${s}, update_existing=${r}`),t&&(t.disabled=!0,t.textContent=swiftCSV.messages.importing),n&&(n.style.display="inline-block"),n&&n.addEventListener("click",function(){p=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),n&&(n.style.display="none")});function d(f=0,m=0,g=0,S=0){p||(addLogEntry(swiftCSV.messages.processingChunk+" "+f,"debug","import"),i.set("start_row",f),i.set("cumulative_created",m),i.set("cumulative_updated",g),i.set("cumulative_errors",S),fetch(swiftCSV.ajaxUrl,{method:"POST",body:i}).then(c=>c.json()).then(c=>{if(!c.success)throw new Error(c.data||"Import failed");if(updateImportProgress(c,a),c.processed&&c.total){const u=Math.round(c.processed/c.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+c.processed+"/"+c.total+" ("+u+"%)","info","import")}c.cumulative_created!==void 0&&addLogEntry(swiftCSV.messages.createdInfo+" "+c.cumulative_created,"success","import"),c.cumulative_updated!==void 0&&addLogEntry(swiftCSV.messages.updatedInfo+" "+c.cumulative_updated,"success","import"),c.cumulative_errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+c.cumulative_errors,"warning","import"),c.continue&&!p?setTimeout(()=>d(c.processed,c.cumulative_created,c.cumulative_updated,c.cumulative_errors),100):completeAjaxImport(c,t,n)}).catch(c=>{console.error("Import error:",c),addLogEntry(swiftCSV.messages.importError+" "+c.message,"error","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),n&&(n.style.display="none")}))}d()}function formatFileSize(e){if(e===0)return"0 Bytes";const o=1024,s=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,r)).toFixed(2))+" "+s[r]}function updateAjaxProgress(e,o){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const r=s.querySelector(".progress-bar-fill"),l=s.querySelector(".processed-rows"),i=s.querySelector(".total-rows"),t=s.querySelector(".percentage");r&&e.progress!==void 0&&(r.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),i&&e.total!==void 0&&(i.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress)}function updateImportProgress(e,o){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const r=s.querySelector(".progress-bar-fill"),l=s.querySelector(".processed-rows"),i=s.querySelector(".total-rows"),t=s.querySelector(".percentage"),n=s.querySelector(".created-count"),a=s.querySelector(".updated-count"),p=s.querySelector(".error-count");r&&e.progress!==void 0&&(r.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),i&&e.total!==void 0&&(i.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress),n&&e.cumulative_created!==void 0&&(n.textContent=e.cumulative_created),a&&e.cumulative_updated!==void 0&&(a.textContent=e.cumulative_updated),p&&e.cumulative_errors!==void 0&&(p.textContent=e.cumulative_errors)}function completeAjaxExport(e,o,s,r){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const l=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(l),t=new Date,n=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0")+"_"+String(t.getHours()).padStart(2,"0")+"-"+String(t.getMinutes()).padStart(2,"0")+"-"+String(t.getSeconds()).padStart(2,"0"),a=`swiftcsv_export_${r}_${n}.csv`,p=document.querySelector("#export-download-btn");p&&(p.href=i,p.download=a,p.classList.add("enabled")),o&&(o.disabled=!1,o.value=swiftCSV.messages.exportCsv),s&&(s.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+a,"info","export")}function completeAjaxImport(e,o,s){addLogEntry(swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0&&addLogEntry(swiftCSV.messages.totalImported+" "+e.cumulative_created,"success","import"),e.cumulative_updated!==void 0&&addLogEntry(swiftCSV.messages.totalUpdated+" "+e.cumulative_updated,"success","import"),e.cumulative_errors!==void 0&&addLogEntry(swiftCSV.messages.totalErrors+" "+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import"),o&&(o.disabled=!1,o.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none");const r=document.querySelector("#ajax_csv_file"),l=document.querySelector("#csv-file-upload"),i=document.querySelector("#csv-file-info");r&&(r.value=""),l&&(l.style.display="block"),i&&(i.style.display="none")}function startBatchExport(e,o){console.warn("startBatchExport is deprecated. Use AJAX export instead.")}
