name: Generate Documentation

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    docs:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.1'
                  extensions: dom, xml
                  coverage: none

            - name: Install dependencies
              run: composer install --no-progress --no-interaction

            - name: Generate API documentation
              run: |
                  composer require --dev phpdocumentor/phpdocumentor
                  ./vendor/bin/phpdoc --config=phpdoc.xml

            - name: Generate README documentation
              run: |
                  # Extract changelog from commits
                  echo "## ðŸ“‹ Recent Changes" > docs/changelog.md
                  git log --oneline --since="1 month ago" >> docs/changelog.md

                  # Generate class overview
                  echo "## ðŸ—ï¸ Class Structure" >> docs/overview.md
                  find includes/ -name "*.php" -exec basename {} .php \; | sort | sed 's/^/- /' >> docs/overview.md

            - name: Deploy to GitHub Pages
              if: github.ref == 'refs/heads/main'
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./docs
