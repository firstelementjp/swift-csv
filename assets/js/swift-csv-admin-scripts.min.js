function __(e,s="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,s):e}document.addEventListener("DOMContentLoaded",function(){initLoggingSystem();const e=document.querySelectorAll('input[name="export_scope"]'),s=document.getElementById("custom-export-help");e.length&&s&&e.forEach(o=>{o.addEventListener("change",function(){s.style.display=this.value==="custom"?"block":"none"})});const r=document.querySelector("#export-csv-btn");r&&r.addEventListener("click",function(o){o.preventDefault();const t=document.querySelector("#post_type")?.value,n=document.querySelector("#posts_per_page")?.value;if(!t||!n||n<1){addLogEntry(swiftCSV.messages.errorOccurred,"error");return}startBatchExport(t,n)});const i=document.querySelector("#swift-csv-ajax-export-form");i&&i.addEventListener("submit",handleAjaxExport);const c=document.querySelector("#swift-csv-ajax-import-form");c&&c.addEventListener("submit",handleAjaxImport),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),s=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),s&&(s.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,s="info",r="export"){const i=document.querySelector(`#${r}-log-content`);if(!i)return;const c=document.createElement("div");c.className=`log-entry log-${s}`;const o=new Date().toLocaleTimeString();c.textContent=`[${o}] ${e}`,i.appendChild(c),i.scrollTop=i.scrollHeight;const t=100,n=i.querySelectorAll(".log-entry");n.length>t&&n[0].remove()}function clearLog(e="export"){const s=document.querySelector(`#${e}-log-content`);s&&(s.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),s=document.querySelector("#ajax_csv_file"),r=document.querySelector("#csv-file-info"),i=document.querySelector("#remove-file-btn");if(!e||!s)return;e.addEventListener("click",()=>{s.click()}),e.addEventListener("dragover",o=>{o.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",o=>{o.preventDefault(),e.classList.remove("dragover");const t=o.dataTransfer.files;t.length>0&&c(t[0])}),s.addEventListener("change",o=>{o.target.files.length>0&&c(o.target.files[0])}),i&&i.addEventListener("click",()=>{s.value="",e.style.display="block",r.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")});function c(o){if(!o.name.toLowerCase().endsWith(".csv")){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const t=10*1024*1024;if(o.size>t){addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");return}const n=r.querySelector(".file-name");n&&(n.textContent=o.name),e.style.display="none",r.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+o.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const s=document.querySelector("#ajax_export_post_type")?.value,r=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",i=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",c=document.querySelector("#export_limit")?.value||"";addLogEntry(swiftCSV.messages.postTypeExport+" "+s,"debug","export");const o=r==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+o,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(i==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(c||swiftCSV.messages.noLimit),"debug","export");const t=document.querySelector("#ajax-export-csv-btn"),n=document.querySelector("#ajax-export-cancel-btn"),f=Date.now();let a=!1;t&&(t.disabled=!0,t.value=swiftCSV.messages.exporting),n&&(n.style.display="inline-block");const d=document.querySelector("#export-download-btn");d&&(d.classList.remove("enabled"),d.href="#",d.removeAttribute("download"));let u="";n&&n.addEventListener("click",function(){a=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),n&&(n.style.display="none")});function l(m=0){if(a)return;addLogEntry(swiftCSV.messages.processingChunk+" "+m,"debug","import");const g=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:s,export_scope:r,include_private_meta:i,export_limit:c,start_row:m});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:g}).then(p=>p.json()).then(p=>{if(!p.success)throw new Error(p.data||"Export failed");if(p.csv_chunk&&(u+=p.csv_chunk),updateAjaxProgress(p,f),p.processed&&p.total){const S=Math.round(p.processed/p.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+p.processed+"/"+p.total+" ("+S+"%)","info","export")}p.continue&&!a?setTimeout(()=>l(p.processed),100):completeAjaxExport(u,t,n,s)}).catch(p=>{console.error("Export error:",p),addLogEntry(swiftCSV.messages.exportError+" "+p.message,"error","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),n&&(n.style.display="none")})}l()}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(swiftCSV.messages.startingImport,"info","import");const s=document.querySelector("#ajax_csv_file"),r=document.querySelector("#ajax_post_type")?.value,i=document.querySelector("#ajax_update_existing")?.checked;if(!s||!s.files.length){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const c=s.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+c.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(c.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+r,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(i?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const o=new FormData;o.append("action","swift_csv_ajax_import"),o.append("nonce",swiftCSV.nonce),o.append("csv_file",c),o.append("post_type",r),o.append("update_existing",i?"1":"0");const t=e.target.querySelector('button[type="submit"]'),n=document.querySelector("#ajax-import-cancel-btn"),f=Date.now();let a=!1;t&&(t.disabled=!0,t.textContent=swiftCSV.messages.importing),n&&(n.style.display="inline-block"),n&&n.addEventListener("click",function(){a=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),n&&(n.style.display="none")});function d(u=0){a||(addLogEntry(swiftCSV.messages.processingChunk+" "+u,"debug","import"),o.set("start_row",u),fetch(swiftCSV.ajaxUrl,{method:"POST",body:o}).then(l=>l.json()).then(l=>{if(!l.success)throw new Error(l.data||"Import failed");if(updateImportProgress(l,f),l.processed&&l.total){const m=Math.round(l.processed/l.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+l.processed+"/"+l.total+" ("+m+"%)","info","import")}l.created!==void 0&&addLogEntry(swiftCSV.messages.createdInfo+" "+l.created,"success","import"),l.updated!==void 0&&addLogEntry(swiftCSV.messages.updatedInfo+" "+l.updated,"success","import"),l.errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+l.errors,"warning","import"),l.continue&&!a?setTimeout(()=>d(l.processed),100):completeAjaxImport(l,t,n)}).catch(l=>{console.error("Import error:",l),addLogEntry(swiftCSV.messages.importError+" "+l.message,"error","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),n&&(n.style.display="none")}))}d()}function formatFileSize(e){if(e===0)return"0 Bytes";const s=1024,r=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(s));return parseFloat((e/Math.pow(s,i)).toFixed(2))+" "+r[i]}function updateAjaxProgress(e,s){const r=document.querySelector(".swift-csv-progress");if(!r){console.warn("Progress container not found");return}const i=r.querySelector(".progress-bar-fill"),c=r.querySelector(".processed-rows"),o=r.querySelector(".total-rows"),t=r.querySelector(".percentage");i&&e.progress!==void 0&&(i.style.width=e.progress+"%"),c&&e.processed!==void 0&&(c.textContent=e.processed),o&&e.total!==void 0&&(o.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress)}function updateImportProgress(e,s){const r=document.querySelector(".swift-csv-progress");if(!r){console.warn("Progress container not found");return}const i=r.querySelector(".progress-bar-fill"),c=r.querySelector(".processed-rows"),o=r.querySelector(".total-rows"),t=r.querySelector(".percentage"),n=r.querySelector(".created-count"),f=r.querySelector(".updated-count"),a=r.querySelector(".error-count");i&&e.progress!==void 0&&(i.style.width=e.progress+"%"),c&&e.processed!==void 0&&(c.textContent=e.processed),o&&e.total!==void 0&&(o.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress),n&&e.created!==void 0&&(n.textContent=e.created),f&&e.updated!==void 0&&(f.textContent=e.updated),a&&e.errors!==void 0&&(a.textContent=e.errors)}function completeAjaxExport(e,s,r,i){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const c=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(c),t=new Date,n=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0")+"_"+String(t.getHours()).padStart(2,"0")+"-"+String(t.getMinutes()).padStart(2,"0")+"-"+String(t.getSeconds()).padStart(2,"0"),f=`swiftcsv_export_${i}_${n}.csv`,a=document.querySelector("#export-download-btn");a&&(a.href=o,a.download=f,a.classList.add("enabled")),s&&(s.disabled=!1,s.value=swiftCSV.messages.exportCsv),r&&(r.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+f,"info","export")}function completeAjaxImport(e,s,r){addLogEntry(swiftCSV.messages.importCompleted,"success","import"),e.imported!==void 0&&addLogEntry(swiftCSV.messages.totalImported+" "+e.imported,"success","import"),e.updated!==void 0&&addLogEntry(swiftCSV.messages.totalUpdated+" "+e.updated,"success","import"),e.errors!==void 0&&addLogEntry(swiftCSV.messages.totalErrors+" "+e.errors,e.errors>0?"warning":"success","import"),s&&(s.disabled=!1,s.textContent=swiftCSV.messages.startImport),r&&(r.style.display="none");const i=document.querySelector("#ajax_csv_file"),c=document.querySelector("#csv-file-upload"),o=document.querySelector("#csv-file-info");i&&(i.value=""),c&&(c.style.display="block"),o&&(o.style.display="none")}function startBatchExport(e,s){addLogEntry(swiftCSV.messages.batchExportStarted,"info","export")}
