function handleAjaxExport(t){t.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const a=document.querySelector(".swift-csv-progress");if(a){const c=a.querySelector(".progress-bar");c&&(c.classList.add("processing"),c.classList.remove("completed"))}const s=document.querySelector("#ajax_export_post_type")?.value,r=document.querySelector('input[name="swift_csv_export_post_status"]:checked')?.value||"publish",l=document.querySelector('input[name="swift_csv_export_scope"]:checked')?.value||"basic",d=document.querySelector('input[name="swift_csv_include_private_meta"]')?.checked?"1":"0",o=document.querySelector('input[name="swift_csv_export_taxonomy_format"]:checked')?.value||"name",p=document.querySelector("#swift_csv_export_limit")?.value||"",w=(Date.now().toString(36)+Math.random().toString(36).slice(2)).replace(/\./g,"");addLogEntry(swiftCSV.messages.postTypeExport+" "+s,"debug","export");const f=l==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportContent+" "+f,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(d==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(p||swiftCSV.messages.noLimit),"debug","export");const n=document.querySelector("#ajax-export-csv-btn"),i=document.querySelector("#ajax-export-cancel-btn"),C=Date.now();let x=!1;n&&(n.disabled=!0,n.value=swiftCSV.messages.exporting),i&&(i.style.display="inline-block");const S=document.querySelector("#export-download-btn");S&&(S.classList.remove("enabled"),S.href="#",S.removeAttribute("download"));let m="",u=null,g=null;i&&(g&&i.removeEventListener("click",g),g=function(){x=!0,window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),u&&u.abort();const c=new URLSearchParams({action:"swift_csv_cancel_export",nonce:swiftCSV.nonce,export_session:w});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c}).catch(()=>{}),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),i&&(i.style.display="none")},i.addEventListener("click",g,{once:!0}));function y(c=0){if(x)return;u=new AbortController,SwiftCSVCore.swiftCSVLog(swiftCSV.messages.processingChunk+" "+c,"debug");const V=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:s,post_status:r,export_scope:l,include_private_meta:d,taxonomy_format:o,export_limit:p,start_row:c,export_session:w});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:V,signal:u.signal}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{if(e.success&&e.continue)m+=e.csv_chunk,updateAjaxProgress(e,C),y(e.processed);else if(e.success)updateAjaxProgress(e,C),m+=e.csv_chunk,completeAjaxExport(m,n,i,s);else{const v=(e&&e.data?e.data:"")||(e&&e.message?e.message:"")||"";throw new Error(v||swiftCSV.messages.exportError)}}).catch(e=>{e&&e.name==="AbortError"||(window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportError+" "+e.message,"error","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),i&&(i.style.display="none"))})}y()}function updateAjaxProgress(t,a){const s=document.querySelector(".swift-csv-progress");if(!s){window.SwiftCSVCore&&window.SwiftCSVCore.swiftCSVLog&&window.SwiftCSVCore.swiftCSVLog("Progress container not found");return}const r=s.querySelector(".progress-bar"),l=s.querySelector(".progress-bar-fill"),d=s.querySelector(".processed-rows"),o=s.querySelector(".total-rows"),p=s.querySelector(".percentage");r&&t.status==="processing"?(r.classList.add("processing"),r.classList.remove("completed")):r&&t.status==="completed"&&(r.classList.remove("processing"),r.classList.add("completed")),l&&t.progress!==void 0&&(l.style.width=t.progress+"%"),d&&t.processed!==void 0&&(d.textContent=t.processed),o&&t.total!==void 0&&(o.textContent=t.total),p&&t.progress!==void 0&&(p.textContent=t.progress)}function completeAjaxExport(t,a,s,r){window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const l=new Blob([t],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(l),o=new Date,p=String(o.getFullYear())+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0")+"-"+String(o.getHours()).padStart(2,"0")+"-"+String(o.getMinutes()).padStart(2,"0")+"-"+String(o.getSeconds()).padStart(2,"0"),w=`swiftcsv_export_${r}_${p}.csv`,f=document.querySelector("#export-download-btn");f&&(f.href=d,f.download=w,f.classList.add("enabled")),a&&(a.disabled=!1,a.value=swiftCSV.messages.exportCsv),s&&(s.style.display="none"),window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.downloadReady+" "+w,"info","export")}window.SwiftCSVExport={handleAjaxExport,updateAjaxProgress,completeAjaxExport};
