function initFileUpload(){const e=document.querySelector("#csv-file-upload"),c=document.querySelector("#ajax_csv_file"),s=document.querySelector("#csv-file-info"),o=document.querySelector("#remove-file-btn");if(!e||!c||e.dataset.swiftCsvInitialized==="true")return;e.dataset.swiftCsvInitialized="true",c.addEventListener("change",i=>{i.target.files.length>0&&handleFileSelect(i.target.files[0])});let n=!1;e.addEventListener("click",function(i){n||(n=!0,setTimeout(()=>{try{c.click()}catch(u){console.error("Error calling fileInput.click():",u)}finally{setTimeout(()=>{n=!1},100)}},0))},!1),e.addEventListener("dragover",i=>{i.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",i=>{i.preventDefault(),e.classList.remove("dragover");const u=i.dataTransfer.files;u.length>0&&handleFileSelect(u[0])}),o&&o.addEventListener("click",()=>{c.value="",s.classList.remove("visible"),e.classList.remove("file-selected")})}function handleFileSelect(e){const c=document.querySelector("#csv-file-info"),s=document.querySelector("#csv-file-upload"),o=document.querySelector("#csv-file-name"),n=document.querySelector("#csv-file-size");c&&s&&o&&n&&(o.textContent=e.name,n.textContent=SwiftCSVCore.formatFileSize(e.size),c.classList.add("visible"),s.classList.add("file-selected"))}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(swiftCSV.messages.startingImport,"info","import");const c=document.querySelector(".swift-csv-progress");if(c){const p=c.querySelector(".progress-bar");p&&(p.classList.add("processing"),p.classList.remove("completed"))}const s=document.querySelector("#ajax_csv_file")?.files[0];if(!s){addLogEntry(swiftCSV.messages.noFileSelected,"error","import");return}const o=document.querySelector("#import_post_type")?.value||"post",n=document.querySelector('input[name="swift_csv_import_update_existing"]')?.checked?"1":"0",i=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",u=document.querySelector('input[name="swift_csv_import_dry_run"]')?.checked?"1":"0";SwiftCSVCore.swiftCSVLog(swiftCSV.messages.fileInfo+" "+s.name,"debug"),SwiftCSVCore.swiftCSVLog(swiftCSV.messages.fileSize+" "+SwiftCSVCore.formatFileSize(s.size),"debug"),SwiftCSVCore.swiftCSVLog(swiftCSV.messages.postTypeInfo+" "+o,"debug"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(n==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const l=document.querySelector("#ajax-import-csv-btn"),t=document.querySelector("#ajax-import-cancel-btn"),a=Date.now();let d=!1;l&&(l.disabled=!0,l.textContent=swiftCSV.messages.processing),t&&(t.style.display="inline-block"),t&&t.addEventListener("click",function(){d=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),l&&(l.disabled=!1,l.textContent=swiftCSV.messages.startImport),t&&(t.style.display="none")}),processImportChunk(0,0,0,0,s,o,n,i,u,l,t,a,d)}function processImportChunk(e=0,c=0,s=0,o=0,n,i,u,l,t,a,d,p,g){if(g)return;SwiftCSVCore.swiftCSVLog(swiftCSV.messages.processingChunk+" "+e,"debug");const f=new FormData;f.append("action","swift_csv_ajax_import"),f.append("nonce",swiftCSV.nonce),f.append("csv_file",n),f.append("post_type",i),f.append("update_existing",u),f.append("taxonomy_format",l),f.append("dry_run",t),f.append("start_row",e),f.append("cumulative_created",c),f.append("cumulative_updated",s),f.append("cumulative_errors",o),fetch(swiftCSV.ajaxUrl,{method:"POST",body:f}).then(r=>r.json()).then(r=>{r.success?(updateImportProgress(r,p),(r.dry_run||!r.dry_run)&&r.dry_run_details&&Array.isArray(r.dry_run_details)&&r.dry_run_details.length>0&&r.dry_run_details.forEach(m=>{const S=m.status==="success"?"\u2713":"\u2717",y=m.action==="create"?swiftCSV.messages.createAction:swiftCSV.messages.updateAction,C=`${r.dry_run?`[${swiftCSV.messages.dryRunPrefix}]`:`[${swiftCSV.messages.importPrefix}]`} ${S} ${swiftCSV.messages.rowLabel}${m.row}: ${y} - "${m.title}"`;addLogEntry(C,m.status==="success"?"success":"error","import")}),r.continue?processImportChunk(r.processed,r.cumulative_created,r.cumulative_updated,r.cumulative_errors,n,i,u,l,t,a,d,p,g):completeAjaxImport(r,a,d)):(addLogEntry(swiftCSV.messages.importError+" "+r.error,"error","import"),a&&(a.disabled=!1,a.textContent=swiftCSV.messages.startImport),d&&(d.style.display="none"))}).catch(r=>{console.error("Import error:",r);let m=r.message;m==="Import failed"&&r.message.includes("Format mismatch detected")&&(m=r.message),addLogEntry(swiftCSV.messages.importError+" "+m,"error","import"),a&&(a.disabled=!1,a.textContent=swiftCSV.messages.startImport),d&&(d.style.display="none")})}function updateImportProgress(e,c){const s=document.querySelector(".swift-csv-progress");if(!s){SwiftCSVCore.swiftCSVLog("Progress container not found");return}const o=s.querySelector(".progress-bar"),n=s.querySelector(".progress-bar-fill"),i=s.querySelector(".processed-rows"),u=s.querySelector(".total-rows"),l=s.querySelector(".percentage");o&&e.status==="processing"?(o.classList.add("processing"),o.classList.remove("completed")):o&&e.status==="completed"&&(o.classList.remove("processing"),o.classList.add("completed"));const t=s.querySelector(".created-count"),a=s.querySelector(".updated-count"),d=s.querySelector(".error-count");n&&e.progress!==void 0&&(n.style.width=e.progress+"%"),i&&e.processed!==void 0&&(i.textContent=e.processed),u&&e.total!==void 0&&(u.textContent=e.total),l&&e.progress!==void 0&&(l.textContent=e.progress),t&&e.created!==void 0&&(t.textContent=e.cumulative_created!==void 0?e.cumulative_created:e.created),a&&e.updated!==void 0&&(a.textContent=e.cumulative_updated!==void 0?e.cumulative_updated:e.updated),d&&e.errors!==void 0&&(d.textContent=e.cumulative_errors!==void 0?e.cumulative_errors:e.errors)}function completeAjaxImport(e,c,s){const o=e.dry_run||!1,n=document.querySelector(".swift-csv-progress");if(n){const t=n.querySelector(".progress-bar");t&&(t.classList.remove("processing"),t.classList.add("completed"))}if(o?addLogEntry("[Dry Run] "+swiftCSV.messages.dryRunCompleted,"success","import"):addLogEntry(swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0){const t=o?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":(swiftCSV.messages.dryRunCreated||swiftCSV.messages.createdInfo||swiftCSV.messages.totalImported||"").replace(/:\s*$/,"")+" ";addLogEntry(t+e.cumulative_created,"success","import")}if(e.cumulative_updated!==void 0){const t=o?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.totalUpdated+" ";addLogEntry(t+e.cumulative_updated,"success","import")}if(e.cumulative_errors!==void 0){const t=o?"[Dry Run] "+swiftCSV.messages.dryRunErrors+" ":swiftCSV.messages.totalErrors+" ";addLogEntry(t+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import")}c&&(c.disabled=!1,c.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none");const i=document.querySelector("#ajax_csv_file"),u=document.querySelector("#csv-file-upload"),l=document.querySelector("#csv-file-info");i&&(i.value=""),u&&u.classList.remove("file-selected"),l&&l.classList.remove("visible")}window.SwiftCSVImport={initFileUpload,handleFileSelect,handleAjaxImport,updateImportProgress,completeAjaxImport};
