function __(e,t="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,t):e}function swiftCSVLog(e,t="info"){if(window.swiftCSV&&window.swiftCSV.debug){const s=new Date().toISOString(),r=`[Swift CSV] ${e}`;switch(t){case"warn":console.warn(r,s);break;case"error":console.error(r,s);break;default:console.info(r,s)}}}document.addEventListener("DOMContentLoaded",function(){swiftCSVLog("JavaScript initialized"),initLoggingSystem();const e=document.querySelectorAll('input[name="swift_csv_export_scope"]'),t=document.getElementById("custom-export-help");e.length&&t&&(swiftCSVLog("Export scope toggle initialized"),e.forEach(a=>{a.addEventListener("change",function(){t.style.display=this.value==="custom"?"block":"none"})})),initFileUpload();const s=document.querySelector("#swift-csv-ajax-export-form");s&&(swiftCSVLog("Ajax export form initialized"),s.addEventListener("submit",handleAjaxExport));const r=document.querySelector("#swift-csv-ajax-import-form");r&&(swiftCSVLog("Ajax import form initialized"),r.addEventListener("submit",handleAjaxImport)),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),t=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),t&&(t.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,t="info",s="export"){const r=document.querySelector(`#${s}-log-content`);if(!r)return;const a=document.createElement("div");a.className=`log-entry log-${t}`;const c=new Date().toLocaleTimeString();a.textContent=`[${c}] ${e}`,r.appendChild(a),r.scrollTop=r.scrollHeight;const o=100,i=r.querySelectorAll(".log-entry");i.length>o&&i[0].remove()}function clearLog(e="export"){const t=document.querySelector(`#${e}-log-content`);t&&(t.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),t=document.querySelector("#ajax_csv_file"),s=document.querySelector("#csv-file-info"),r=document.querySelector("#remove-file-btn");if(!e||!t||e.dataset.swiftCsvInitialized==="true")return;e.dataset.swiftCsvInitialized="true",t.addEventListener("change",o=>{o.target.files.length>0&&c(o.target.files[0])});let a=!1;e.addEventListener("click",function(o){a||(a=!0,setTimeout(()=>{try{t.click()}catch(i){console.error("Error calling fileInput.click():",i)}finally{setTimeout(()=>{a=!1},100)}},0))},!1),e.addEventListener("dragover",o=>{o.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",o=>{o.preventDefault(),e.classList.remove("dragover");const i=o.dataTransfer.files;i.length>0&&c(i[0])}),r&&r.addEventListener("click",()=>{t.value="",e.style.display="block",s.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")});function c(o){if(!o.name.toLowerCase().endsWith(".csv")){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const i=10*1024*1024;if(o.size>i){swiftCSVLog(`File size validation failed: ${o.size} bytes exceeds ${i} bytes`,"warn"),addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");return}swiftCSVLog(`File selected: ${o.name} (${o.size} bytes)`);const l=s.querySelector(".file-name");l&&(l.textContent=o.name),e.style.display="none",s.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+o.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const t=document.querySelector("#ajax_export_post_type")?.value,s=document.querySelector('input[name="swift_csv_export_scope"]:checked')?.value||"basic",r=document.querySelector('input[name="swift_csv_include_private_meta"]')?.checked?"1":"0",a=document.querySelector('input[name="swift_csv_export_taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#swift_csv_export_limit")?.value||"",o=(Date.now().toString(36)+Math.random().toString(36).slice(2)).replace(/\./g,"");addLogEntry(swiftCSV.messages.postTypeExport+" "+t,"debug","export");const i=s==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+i,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(r==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(c||swiftCSV.messages.noLimit),"debug","export");const l=document.querySelector("#ajax-export-csv-btn"),u=document.querySelector("#ajax-export-cancel-btn"),_=Date.now();let p=!1;l&&(l.disabled=!0,l.value=swiftCSV.messages.exporting),u&&(u.style.display="inline-block");const m=document.querySelector("#export-download-btn");m&&(m.classList.remove("enabled"),m.href="#",m.removeAttribute("download"));let w="",g=null,y=null;u&&(y&&u.removeEventListener("click",y),y=function(){p=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),g&&g.abort();const n=new URLSearchParams({action:"swift_csv_cancel_export",nonce:swiftCSV.nonce,export_session:o});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}).catch(()=>{}),l&&(l.disabled=!1,l.value=swiftCSV.messages.exportCsv),u&&(u.style.display="none")},u.addEventListener("click",y,{once:!0}));function S(n=0){if(p)return;g=new AbortController,addLogEntry(swiftCSV.messages.processingChunk+" "+n,"debug","import");const f=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:t,export_scope:s,include_private_meta:r,taxonomy_format:a,export_limit:c,start_row:n,export_session:o});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:f,signal:g.signal}).then(d=>d.json()).then(d=>{if(!d.success)throw new Error(d.data||"Export failed");if(d.csv_chunk&&(w+=d.csv_chunk),updateAjaxProgress(d,_),d.processed&&d.total){const v=Math.round(d.processed/d.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+d.processed+"/"+d.total+" ("+v+"%)","info","export")}d.continue&&!p?setTimeout(()=>S(d.processed),100):completeAjaxExport(w,l,u,t)}).catch(d=>{d&&d.name==="AbortError"||(console.error("Export error:",d),addLogEntry(swiftCSV.messages.exportError+" "+d.message,"error","export"),l&&(l.disabled=!1,l.value=swiftCSV.messages.exportCsv),u&&(u.style.display="none"))})}S()}function handleAjaxImport(e){e.preventDefault(),clearLog("import");const t=document.querySelector("#ajax_csv_file"),s=document.querySelector("#ajax_post_type")?.value,r=document.querySelector("#ajax_update_existing")?.checked,a=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#dry_run")?.checked||!1;if(c&&addLogEntry("[Dry Run] "+swiftCSV.messages.dryRunNotice,"info","import"),addLogEntry(swiftCSV.messages.startingImport,"info","import"),!t||!t.files.length){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const o=t.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+o.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(o.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+s,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(r?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const i=new FormData;i.append("action","swift_csv_ajax_import"),i.append("nonce",swiftCSV.nonce),i.append("csv_file",o),i.append("post_type",s),i.append("update_existing",r?"1":"0"),i.append("taxonomy_format",a),i.append("dry_run",c?"1":"0");const l=e.target.querySelector('button[type="submit"]'),u=document.querySelector("#ajax-import-cancel-btn"),_=Date.now();let p=!1;swiftCSVLog(`Import started: post_type=${s}, update_existing=${r}, taxonomy_format=${a}, dry_run=${c}`),l&&(l.disabled=!0,l.textContent=swiftCSV.messages.importing),u&&(u.style.display="inline-block"),u&&u.addEventListener("click",function(){p=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),l&&(l.disabled=!1,l.textContent=swiftCSV.messages.startImport),u&&(u.style.display="none")});function m(w=0,g=0,y=0,S=0){p||(addLogEntry(swiftCSV.messages.processingChunk+" "+w,"debug","import"),i.set("start_row",w),i.set("cumulative_created",g),i.set("cumulative_updated",y),i.set("cumulative_errors",S),fetch(swiftCSV.ajaxUrl,{method:"POST",body:i}).then(n=>n.json()).then(n=>{if(!n.success)throw new Error(n.error||"Import failed");if(updateImportProgress(n,_),n.processed&&n.total){const f=Math.round(n.processed/n.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+n.processed+"/"+n.total+" ("+f+"%)","info","import")}if(c&&(n.dry_run_details&&Array.isArray(n.dry_run_details)&&n.dry_run_details.length>0&&(addLogEntry("[Dry Run] \u8A73\u7D30\u306A\u51E6\u7406\u7D50\u679C:","info","import"),n.dry_run_details.forEach(f=>{const d=f.status==="success"?"\u2713":"\u2717",v=f.action==="create"?"\u65B0\u898F\u4F5C\u6210":"\u66F4\u65B0",x=`[Dry Run] ${d} \u884C${f.row}: ${v} - "${f.title}"`;addLogEntry(x,f.status==="success"?"success":"error","import"),f.details&&addLogEntry(`    ${f.details}`,"debug","import")})),n.dry_run_log&&Array.isArray(n.dry_run_log)&&n.dry_run_log.length>0&&n.dry_run_log.forEach(f=>{f&&f.trim()!==""&&addLogEntry("[Dry Run] "+f,"info","import")})),n.cumulative_created!==void 0){const f=c?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.createdInfo;addLogEntry(f+" "+n.cumulative_created,"success","import")}if(n.cumulative_updated!==void 0){const f=c?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.updatedInfo;addLogEntry(f+" "+n.cumulative_updated,"info","import")}n.cumulative_errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+n.cumulative_errors,"warning","import"),n.continue&&!p?setTimeout(()=>m(n.processed,n.cumulative_created,n.cumulative_updated,n.cumulative_errors),100):completeAjaxImport(n,l,u)}).catch(n=>{console.error("Import error:",n);let f=n.message;f==="Import failed"&&n.message.includes("Format mismatch detected")&&(f=n.message),addLogEntry(swiftCSV.messages.importError+" "+f,"error","import"),l&&(l.disabled=!1,l.textContent=swiftCSV.messages.startImport),u&&(u.style.display="none")}))}m()}function formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(2))+" "+s[r]}function updateAjaxProgress(e,t){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const r=s.querySelector(".progress-bar-fill"),a=s.querySelector(".processed-rows"),c=s.querySelector(".total-rows"),o=s.querySelector(".percentage");r&&e.progress!==void 0&&(r.style.width=e.progress+"%"),a&&e.processed!==void 0&&(a.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress)}function updateImportProgress(e,t){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const r=s.querySelector(".progress-bar-fill"),a=s.querySelector(".processed-rows"),c=s.querySelector(".total-rows"),o=s.querySelector(".percentage"),i=s.querySelector(".created-count"),l=s.querySelector(".updated-count"),u=s.querySelector(".error-count");r&&e.progress!==void 0&&(r.style.width=e.progress+"%"),a&&e.processed!==void 0&&(a.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress),i&&e.cumulative_created!==void 0&&(i.textContent=e.cumulative_created),l&&e.cumulative_updated!==void 0&&(l.textContent=e.cumulative_updated),u&&e.cumulative_errors!==void 0&&(u.textContent=e.cumulative_errors)}function completeAjaxExport(e,t,s,r){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(a),o=new Date,i=o.getFullYear()+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0")+"_"+String(o.getHours()).padStart(2,"0")+"-"+String(o.getMinutes()).padStart(2,"0")+"-"+String(o.getSeconds()).padStart(2,"0"),l=`swiftcsv_export_${r}_${i}.csv`,u=document.querySelector("#export-download-btn");u&&(u.href=c,u.download=l,u.classList.add("enabled")),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),s&&(s.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+l,"info","export")}function completeAjaxImport(e,t,s){const r=e.dry_run||!1;if(addLogEntry(r?"[Dry Run] "+swiftCSV.messages.dryRunCompleted:swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0){const i=r?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.totalImported+" ";addLogEntry(i+e.cumulative_created,"success","import")}if(e.cumulative_updated!==void 0){const i=r?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.totalUpdated+" ";addLogEntry(i+e.cumulative_updated,"success","import")}if(e.cumulative_errors!==void 0){const i=r?"[Dry Run] "+swiftCSV.messages.dryRunErrors+" ":swiftCSV.messages.totalErrors+" ";addLogEntry(i+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import")}t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none");const a=document.querySelector("#ajax_csv_file"),c=document.querySelector("#csv-file-upload"),o=document.querySelector("#csv-file-info");a&&(a.value=""),c&&(c.style.display="block"),o&&(o.style.display="none")}const licenseInput=document.getElementById("swift_csv_pro_license_key_input"),licenseToggle=document.getElementById("swift_csv_pro_license_toggle_visibility");licenseInput&&licenseToggle&&licenseToggle.addEventListener("click",()=>{const e=licenseInput.type==="password";licenseInput.type=e?"text":"password",licenseToggle.textContent=e?swiftCSV.messages.hide:swiftCSV.messages.show});async function wpPost(e,t={}){const s=new URLSearchParams({action:e,...t});return(await fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s})).json()}document.body.addEventListener("click",async e=>{const t=e.target.closest(".swift-csv-license-button");if(!t)return;const s=t.dataset.action;if(!s){console.error("No action found on button:",t);return}const r=document.getElementById("swift_csv_pro_license_key_input"),a=r?r.value:"",c=t.closest("div")?t.closest("div").querySelector(".spinner"):null;if(!a&&s==="activate"){alert(__("Please enter a license key.","swift-csv-pro"));return}t.disabled=!0,c&&(c.style.visibility="visible");try{const o=await wpPost("swift_csv_pro_manage_license",{nonce:swiftCSV.nonce,license_key:a,license_action:s});if(!o.success)throw new Error(o.data?.message||__("License operation failed.","swift-csv-pro"));location.reload()}catch(o){console.error("License error:",o),alert(o.message||__("An error occurred while processing your request. Please try again.","swift-csv-pro"))}finally{t.disabled=!1,c&&(c.style.visibility="hidden")}});
