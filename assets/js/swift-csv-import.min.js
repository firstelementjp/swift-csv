function initFileUpload(){const e=document.querySelector("#csv-file-upload"),o=document.querySelector("#ajax_csv_file"),i=document.querySelector("#csv-file-info"),n=document.querySelector("#remove-file-btn");if(!e||!o||e.dataset.swiftCsvInitialized==="true")return;e.dataset.swiftCsvInitialized="true",o.addEventListener("change",c=>{c.target.files.length>0&&handleFileSelect(c.target.files[0])});let l=!1;e.addEventListener("click",function(c){l||(l=!0,setTimeout(()=>{try{o.click()}catch(t){console.error("Error calling fileInput.click():",t)}finally{setTimeout(()=>{l=!1},100)}},0))},!1),e.addEventListener("dragover",c=>{c.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",c=>{c.preventDefault(),e.classList.remove("dragover");const t=c.dataTransfer.files;t.length>0&&handleFileSelect(t[0])}),n&&n.addEventListener("click",()=>{o.value="",i.style.display="none",e.classList.remove("file-selected")})}function handleFileSelect(e){const o=document.querySelector("#csv-file-info"),i=document.querySelector("#csv-file-upload"),n=document.querySelector("#csv-file-name"),l=document.querySelector("#csv-file-size");o&&i&&n&&l&&(n.textContent=e.name,l.textContent=SwiftCSVCore.formatFileSize(e.size),o.style.display="block",i.classList.add("file-selected"))}function handleAjaxImport(e){e.preventDefault(),clearLog("import"),addLogEntry(swiftCSV.messages.startingImport,"info","import");const o=document.querySelector("#ajax_csv_file")?.files[0],i=document.querySelector("#import_post_type")?.value||"post",n=document.querySelector("#update_existing")?.checked?"1":"0",l=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#dry_run")?.checked?"1":"0";SwiftCSVCore.swiftCSVLog(swiftCSV.messages.fileInfo+" "+o.name,"debug"),SwiftCSVCore.swiftCSVLog(swiftCSV.messages.fileSize+" "+SwiftCSVCore.formatFileSize(o.size),"debug"),SwiftCSVCore.swiftCSVLog(swiftCSV.messages.postTypeInfo+" "+i,"debug"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(n?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const t=document.querySelector("#ajax-import-csv-btn"),s=document.querySelector("#ajax-import-cancel-btn"),p=Date.now();let f=!1;t&&(t.disabled=!0,t.textContent=swiftCSV.messages.importing),s&&(s.style.display="inline-block"),s&&s.addEventListener("click",function(){f=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none")});function u(m=0,g=0,S=0,y=0){if(f)return;SwiftCSVCore.swiftCSVLog(swiftCSV.messages.processingChunk+" "+m,"debug");const a=new FormData;a.append("action","swift_csv_ajax_import"),a.append("nonce",swiftCSV.nonce),a.append("csv_file",o),a.append("post_type",i),a.append("update_existing",n),a.append("taxonomy_format",l),a.append("dry_run",c),a.append("start_row",m),a.append("cumulative_created",g),a.append("cumulative_updated",S),a.append("cumulative_errors",y),fetch(swiftCSV.ajaxUrl,{method:"POST",body:a}).then(r=>r.json()).then(r=>{r.success&&r.continue?(updateImportProgress(r,p),u(r.processed,r.cumulative_created,r.cumulative_updated,r.cumulative_errors)):r.success?completeAjaxImport(r,t,s):(addLogEntry(swiftCSV.messages.importError+" "+r.error,"error","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none"))}).catch(r=>{console.error("Import error:",r);let d=r.message;d==="Import failed"&&r.message.includes("Format mismatch detected")&&(d=r.message),addLogEntry(swiftCSV.messages.importError+" "+d,"error","import"),t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none")})}u()}function updateImportProgress(e,o){const i=document.querySelector(".swift-csv-progress");if(!i){SwiftCSVCore.swiftCSVLog("Progress container not found");return}const n=i.querySelector(".progress-bar-fill"),l=i.querySelector(".processed-rows"),c=i.querySelector(".total-rows"),t=i.querySelector(".percentage");n&&e.progress!==void 0&&(n.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),t&&e.progress!==void 0&&(t.textContent=e.progress)}function completeAjaxImport(e,o,i){const n=e.dry_run||!1;if(n?addLogEntry("[Dry Run] "+swiftCSV.messages.dryRunCompleted,"success","import"):addLogEntry(swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0){const s=n?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.totalImported+" ";addLogEntry(s+e.cumulative_created,"success","import")}if(e.cumulative_updated!==void 0){const s=n?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.totalUpdated+" ";addLogEntry(s+e.cumulative_updated,"success","import")}if(e.cumulative_errors!==void 0){const s=n?"[Dry Run] "+swiftCSV.messages.dryRunErrors+" ":swiftCSV.messages.totalErrors+" ";addLogEntry(s+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import")}o&&(o.disabled=!1,o.textContent=swiftCSV.messages.startImport),i&&(i.style.display="none");const l=document.querySelector("#ajax_csv_file"),c=document.querySelector("#csv-file-upload"),t=document.querySelector("#csv-file-info");l&&(l.value=""),c&&c.classList.remove("file-selected"),t&&(t.style.display="none")}window.SwiftCSVImport={initFileUpload,handleFileSelect,handleAjaxImport,updateImportProgress,completeAjaxImport};
