function handleAjaxExport(s){s.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const i=document.querySelector("#ajax_export_post_type")?.value,n=document.querySelector('input[name="swift_csv_export_scope"]:checked')?.value||"basic",a=document.querySelector('input[name="swift_csv_include_private_meta"]')?.checked?"1":"0",l=document.querySelector('input[name="swift_csv_export_taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#swift_csv_export_limit")?.value||"",r=(Date.now().toString(36)+Math.random().toString(36).slice(2)).replace(/\./g,"");addLogEntry(swiftCSV.messages.postTypeExport+" "+i,"debug","export");const g=n==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+g,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(a==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(c||swiftCSV.messages.noLimit),"debug","export");const t=document.querySelector("#ajax-export-csv-btn"),e=document.querySelector("#ajax-export-cancel-btn"),w=Date.now();let x=!1;t&&(t.disabled=!0,t.value=swiftCSV.messages.exporting),e&&(e.style.display="inline-block");const p=document.querySelector("#export-download-btn");p&&(p.classList.remove("enabled"),p.href="#",p.removeAttribute("download"));let S="",d=null,f=null;e&&(f&&e.removeEventListener("click",f),f=function(){x=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),d&&d.abort();const u=new URLSearchParams({action:"swift_csv_cancel_export",nonce:swiftCSV.nonce,export_session:r});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:u}).catch(()=>{}),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),e&&(e.style.display="none")},e.addEventListener("click",f,{once:!0}));function m(u=0){if(x)return;d=new AbortController,SwiftCSVCore.swiftCSVLog(swiftCSV.messages.processingChunk+" "+u,"debug");const C=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:i,export_scope:n,include_private_meta:a,taxonomy_format:l,export_limit:c,start_row:u,export_session:r});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:C,signal:d.signal}).then(o=>o.json()).then(o=>{if(o.success&&o.continue)S+=o.csv_chunk,updateAjaxProgress(o,w),m(o.processed);else if(o.success)S+=o.csv_chunk,completeAjaxExport(S,t,e,i);else{if(error&&error.name==="AbortError")return;console.error("Export error:",error),addLogEntry(swiftCSV.messages.exportError+" "+error.message,"error","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),e&&(e.style.display="none")}}).catch(o=>{o&&o.name==="AbortError"||(console.error("Export error:",o),addLogEntry(swiftCSV.messages.exportError+" "+o.message,"error","export"),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),e&&(e.style.display="none"))})}m()}function updateAjaxProgress(s,i){const n=document.querySelector(".swift-csv-progress");if(!n){SwiftCSVCore.swiftCSVLog("Progress container not found");return}const a=n.querySelector(".progress-bar-fill"),l=n.querySelector(".processed-rows"),c=n.querySelector(".total-rows"),r=n.querySelector(".percentage");a&&s.progress!==void 0&&(a.style.width=s.progress+"%"),l&&s.processed!==void 0&&(l.textContent=s.processed),c&&s.total!==void 0&&(c.textContent=s.total),r&&s.progress!==void 0&&(r.textContent=s.progress)}function completeAjaxExport(s,i,n,a){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const l=new Blob([s],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(l),r=new Date,g=String(r.getFullYear())+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0")+"-"+String(r.getHours()).padStart(2,"0")+"-"+String(r.getMinutes()).padStart(2,"0")+"-"+String(r.getSeconds()).padStart(2,"0"),t=`swiftcsv_export_${a}_${g}.csv`,e=document.querySelector("#export-download-btn");e&&(e.href=c,e.download=t,e.classList.add("enabled")),i&&(i.disabled=!1,i.value=swiftCSV.messages.exportCsv),n&&(n.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+t,"info","export")}window.SwiftCSVExport={handleAjaxExport,updateAjaxProgress,completeAjaxExport};
