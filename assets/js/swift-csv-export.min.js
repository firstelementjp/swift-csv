function handleAjaxExport(s){s.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const i=document.querySelector("#ajax_export_post_type")?.value,n=document.querySelector('input[name="swift_csv_export_scope"]:checked')?.value||"basic",a=document.querySelector('input[name="swift_csv_include_private_meta"]')?.checked?"1":"0",l=document.querySelector('input[name="swift_csv_export_taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#swift_csv_export_limit")?.value||"",r=(Date.now().toString(36)+Math.random().toString(36).slice(2)).replace(/\./g,"");addLogEntry(swiftCSV.messages.postTypeExport+" "+i,"debug","export");const S=n==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+S,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(a==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(c||swiftCSV.messages.noLimit),"debug","export");const o=document.querySelector("#ajax-export-csv-btn"),e=document.querySelector("#ajax-export-cancel-btn"),g=Date.now();let C=!1;o&&(o.disabled=!0,o.value=swiftCSV.messages.exporting),e&&(e.style.display="inline-block");const d=document.querySelector("#export-download-btn");d&&(d.classList.remove("enabled"),d.href="#",d.removeAttribute("download"));let u="",w=null,f=null;e&&(f&&e.removeEventListener("click",f),f=function(){C=!0,window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),w&&w.abort();const p=new URLSearchParams({action:"swift_csv_cancel_export",nonce:swiftCSV.nonce,export_session:r});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:p}).catch(()=>{}),o&&(o.disabled=!1,o.value=swiftCSV.messages.exportCsv),e&&(e.style.display="none")},e.addEventListener("click",f,{once:!0}));function x(p=0){if(C)return;w=new AbortController,SwiftCSVCore.swiftCSVLog(swiftCSV.messages.processingChunk+" "+p,"debug");const m=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:i,export_scope:n,include_private_meta:a,taxonomy_format:l,export_limit:c,start_row:p,export_session:r});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:m,signal:w.signal}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{if(t.success&&t.continue)u+=t.csv_chunk,updateAjaxProgress(t,g),x(t.processed);else if(t.success)updateAjaxProgress(t,g),u+=t.csv_chunk,completeAjaxExport(u,o,e,i);else{if(error&&error.name==="AbortError")return;console.error("Export error:",error),window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportError+" "+error.message,"error","export"),o&&(o.disabled=!1,o.value=swiftCSV.messages.exportCsv),e&&(e.style.display="none")}}).catch(t=>{t&&t.name==="AbortError"||(console.error("Export error:",t),window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportError+" "+t.message,"error","export"),o&&(o.disabled=!1,o.value=swiftCSV.messages.exportCsv),e&&(e.style.display="none"))})}x()}function updateAjaxProgress(s,i){const n=document.querySelector(".swift-csv-progress");if(!n){window.SwiftCSVCore&&window.SwiftCSVCore.swiftCSVLog&&window.SwiftCSVCore.swiftCSVLog("Progress container not found");return}const a=n.querySelector(".progress-bar-fill"),l=n.querySelector(".processed-rows"),c=n.querySelector(".total-rows"),r=n.querySelector(".percentage");a&&s.progress!==void 0&&(a.style.width=s.progress+"%"),l&&s.processed!==void 0&&(l.textContent=s.processed),c&&s.total!==void 0&&(c.textContent=s.total),r&&s.progress!==void 0&&(r.textContent=s.progress)}function completeAjaxExport(s,i,n,a){window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const l=new Blob([s],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(l),r=new Date,S=String(r.getFullYear())+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0")+"-"+String(r.getHours()).padStart(2,"0")+"-"+String(r.getMinutes()).padStart(2,"0")+"-"+String(r.getSeconds()).padStart(2,"0"),o=`swiftcsv_export_${a}_${S}.csv`,e=document.querySelector("#export-download-btn");e&&(e.href=c,e.download=o,e.classList.add("enabled")),i&&(i.disabled=!1,i.value=swiftCSV.messages.exportCsv),n&&(n.style.display="none"),window.SwiftCSVUtils&&window.SwiftCSVUtils.addLogEntry&&window.SwiftCSVUtils.addLogEntry(swiftCSV.messages.downloadReady+" "+o,"info","export")}window.SwiftCSVExport={handleAjaxExport,updateAjaxProgress,completeAjaxExport};
