function __(e,t="swift-csv"){return window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__(e,t):e}function swiftCSVLog(e,t="info"){if(window.swiftCSV&&window.swiftCSV.debug){const s=new Date().toISOString(),r=`[Swift CSV] ${e}`;switch(t){case"warn":console.warn(r,s);break;case"error":console.error(r,s);break;default:console.log(r,s)}}}document.addEventListener("DOMContentLoaded",function(){swiftCSVLog("JavaScript initialized"),initLoggingSystem();const e=document.querySelectorAll('input[name="export_scope"]'),t=document.getElementById("custom-export-help");e.length&&t&&(swiftCSVLog("Export scope toggle initialized"),e.forEach(l=>{l.addEventListener("change",function(){t.style.display=this.value==="custom"?"block":"none"})})),initFileUpload();const s=document.querySelector("#swift-csv-ajax-export-form");s&&(swiftCSVLog("Ajax export form initialized"),s.addEventListener("submit",handleAjaxExport));const r=document.querySelector("#swift-csv-ajax-import-form");r&&(swiftCSVLog("Ajax import form initialized"),r.addEventListener("submit",handleAjaxImport)),initFileUpload()});function initLoggingSystem(){const e=document.querySelector("#export-log-content"),t=document.querySelector("#import-log-content");e&&(e.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToExport||"Ready to start export...")+"</div>"),t&&(t.innerHTML='<div class="log-entry log-info">'+(swiftCSV.messages.readyToImport||"Ready to start import...")+"</div>")}function addLogEntry(e,t="info",s="export"){const r=document.querySelector(`#${s}-log-content`);if(!r)return;const l=document.createElement("div");l.className=`log-entry log-${t}`;const c=new Date().toLocaleTimeString();l.textContent=`[${c}] ${e}`,r.appendChild(l),r.scrollTop=r.scrollHeight;const o=100,n=r.querySelectorAll(".log-entry");n.length>o&&n[0].remove()}function clearLog(e="export"){const t=document.querySelector(`#${e}-log-content`);t&&(t.innerHTML="")}function initFileUpload(){const e=document.querySelector("#csv-file-upload"),t=document.querySelector("#ajax_csv_file"),s=document.querySelector("#csv-file-info"),r=document.querySelector("#remove-file-btn");if(!e||!t||e.dataset.swiftCsvInitialized==="true")return;e.dataset.swiftCsvInitialized="true",t.addEventListener("change",o=>{o.target.files.length>0&&c(o.target.files[0])});let l=!1;e.addEventListener("click",function(o){l||(l=!0,setTimeout(()=>{try{t.click()}catch(n){console.error("Error calling fileInput.click():",n)}finally{setTimeout(()=>{l=!1},100)}},0))},!1),e.addEventListener("dragover",o=>{o.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",o=>{o.preventDefault(),e.classList.remove("dragover");const n=o.dataTransfer.files;n.length>0&&c(n[0])}),r&&r.addEventListener("click",()=>{t.value="",e.style.display="block",s.style.display="none",addLogEntry(swiftCSV.messages.fileRemoved,"info","import")});function c(o){if(!o.name.toLowerCase().endsWith(".csv")){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const n=10*1024*1024;if(o.size>n){swiftCSVLog(`File size validation failed: ${o.size} bytes exceeds ${n} bytes`,"warn"),addLogEntry(swiftCSV.messages.fileSizeExceedsLimit,"error","import");return}swiftCSVLog(`File selected: ${o.name} (${o.size} bytes)`);const a=s.querySelector(".file-name");a&&(a.textContent=o.name),e.style.display="none",s.style.display="flex",addLogEntry(swiftCSV.messages.fileSelected+" "+o.name,"success","import")}}function handleAjaxExport(e){e.preventDefault(),clearLog("export"),addLogEntry(swiftCSV.messages.startingExport,"info","export");const t=document.querySelector("#ajax_export_post_type")?.value,s=document.querySelector('input[name="export_scope"]:checked')?.value||"basic",r=document.querySelector('input[name="include_private_meta"]')?.checked?"1":"0",l=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#export_limit")?.value||"";addLogEntry(swiftCSV.messages.postTypeExport+" "+t,"debug","export");const o=s==="basic"?swiftCSV.messages.exportScopeBasic:swiftCSV.messages.exportScopeAll;addLogEntry(swiftCSV.messages.exportScope+" "+o,"debug","export"),addLogEntry(swiftCSV.messages.includePrivateMeta+" "+(r==="1"?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","export"),addLogEntry(swiftCSV.messages.exportLimit+" "+(c||swiftCSV.messages.noLimit),"debug","export");const n=document.querySelector("#ajax-export-csv-btn"),a=document.querySelector("#ajax-export-cancel-btn"),d=Date.now();let m=!1;n&&(n.disabled=!0,n.value=swiftCSV.messages.exporting),a&&(a.style.display="inline-block");const p=document.querySelector("#export-download-btn");p&&(p.classList.remove("enabled"),p.href="#",p.removeAttribute("download"));let g="";a&&a.addEventListener("click",function(){m=!0,addLogEntry(swiftCSV.messages.exportCancelledByUser,"warning","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),a&&(a.style.display="none")});function y(w=0){if(m)return;addLogEntry(swiftCSV.messages.processingChunk+" "+w,"debug","import");const S=new URLSearchParams({action:"swift_csv_ajax_export",nonce:swiftCSV.nonce,post_type:t,export_scope:s,include_private_meta:r,taxonomy_format:l,export_limit:c,start_row:w});fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:S}).then(u=>u.json()).then(u=>{if(!u.success)throw new Error(u.data||"Export failed");if(u.csv_chunk&&(g+=u.csv_chunk),updateAjaxProgress(u,d),u.processed&&u.total){const i=Math.round(u.processed/u.total*100);addLogEntry(swiftCSV.messages.processedExport+" "+u.processed+"/"+u.total+" ("+i+"%)","info","export")}u.continue&&!m?setTimeout(()=>y(u.processed),100):completeAjaxExport(g,n,a,t)}).catch(u=>{console.error("Export error:",u),addLogEntry(swiftCSV.messages.exportError+" "+u.message,"error","export"),n&&(n.disabled=!1,n.value=swiftCSV.messages.exportCsv),a&&(a.style.display="none")})}y()}function handleAjaxImport(e){e.preventDefault(),clearLog("import");const t=document.querySelector("#ajax_csv_file"),s=document.querySelector("#ajax_post_type")?.value,r=document.querySelector("#ajax_update_existing")?.checked,l=document.querySelector('input[name="taxonomy_format"]:checked')?.value||"name",c=document.querySelector("#dry_run")?.checked||!1;if(c&&addLogEntry("[Dry Run] "+swiftCSV.messages.dryRunNotice,"info","import"),addLogEntry(swiftCSV.messages.startingImport,"info","import"),!t||!t.files.length){addLogEntry(swiftCSV.messages.selectCsvFile,"error","import");return}const o=t.files[0];addLogEntry(swiftCSV.messages.fileInfo+" "+o.name,"debug","import"),addLogEntry(swiftCSV.messages.fileSize+" "+formatFileSize(o.size),"debug","import"),addLogEntry(swiftCSV.messages.postTypeInfo+" "+s,"debug","import"),addLogEntry(swiftCSV.messages.updateExistingInfo+" "+(r?swiftCSV.messages.yes:swiftCSV.messages.no),"debug","import");const n=new FormData;n.append("action","swift_csv_ajax_import"),n.append("nonce",swiftCSV.nonce),n.append("csv_file",o),n.append("post_type",s),n.append("update_existing",r?"1":"0"),n.append("taxonomy_format",l),n.append("dry_run",c?"1":"0");const a=e.target.querySelector('button[type="submit"]'),d=document.querySelector("#ajax-import-cancel-btn"),m=Date.now();let p=!1;swiftCSVLog(`Import started: post_type=${s}, update_existing=${r}, taxonomy_format=${l}, dry_run=${c}`),a&&(a.disabled=!0,a.textContent=swiftCSV.messages.importing),d&&(d.style.display="inline-block"),d&&d.addEventListener("click",function(){p=!0,addLogEntry(swiftCSV.messages.importCancelledByUser,"warning","import"),a&&(a.disabled=!1,a.textContent=swiftCSV.messages.startImport),d&&(d.style.display="none")});function g(y=0,w=0,S=0,u=0){p||(addLogEntry(swiftCSV.messages.processingChunk+" "+y,"debug","import"),n.set("start_row",y),n.set("cumulative_created",w),n.set("cumulative_updated",S),n.set("cumulative_errors",u),fetch(swiftCSV.ajaxUrl,{method:"POST",body:n}).then(i=>i.json()).then(i=>{if(!i.success)throw new Error(i.error||"Import failed");if(updateImportProgress(i,m),i.processed&&i.total){const f=Math.round(i.processed/i.total*100);addLogEntry(swiftCSV.messages.processedInfo+" "+i.processed+"/"+i.total+" ("+f+"%)","info","import")}if(c&&i.dry_run_log&&Array.isArray(i.dry_run_log)&&i.dry_run_log.length>0&&i.dry_run_log.forEach(f=>{f&&f.trim()!==""&&addLogEntry("[Dry Run] "+f,"info","import")}),i.cumulative_created!==void 0){const f=c?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.createdInfo;addLogEntry(f+" "+i.cumulative_created,"success","import")}if(i.cumulative_updated!==void 0){const f=c?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.updatedInfo;addLogEntry(f+" "+i.cumulative_updated,"info","import")}i.cumulative_errors>0&&addLogEntry(swiftCSV.messages.errorsInfo+" "+i.cumulative_errors,"warning","import"),i.continue&&!p?setTimeout(()=>g(i.processed,i.cumulative_created,i.cumulative_updated,i.cumulative_errors),100):completeAjaxImport(i,a,d)}).catch(i=>{console.error("Import error:",i);let f=i.message;f==="Import failed"&&i.message.includes("Format mismatch detected")&&(f=i.message),addLogEntry(swiftCSV.messages.importError+" "+f,"error","import"),a&&(a.disabled=!1,a.textContent=swiftCSV.messages.startImport),d&&(d.style.display="none")}))}g()}function formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(2))+" "+s[r]}function updateAjaxProgress(e,t){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const r=s.querySelector(".progress-bar-fill"),l=s.querySelector(".processed-rows"),c=s.querySelector(".total-rows"),o=s.querySelector(".percentage");r&&e.progress!==void 0&&(r.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress)}function updateImportProgress(e,t){const s=document.querySelector(".swift-csv-progress");if(!s){console.warn("Progress container not found");return}const r=s.querySelector(".progress-bar-fill"),l=s.querySelector(".processed-rows"),c=s.querySelector(".total-rows"),o=s.querySelector(".percentage"),n=s.querySelector(".created-count"),a=s.querySelector(".updated-count"),d=s.querySelector(".error-count");r&&e.progress!==void 0&&(r.style.width=e.progress+"%"),l&&e.processed!==void 0&&(l.textContent=e.processed),c&&e.total!==void 0&&(c.textContent=e.total),o&&e.progress!==void 0&&(o.textContent=e.progress),n&&e.cumulative_created!==void 0&&(n.textContent=e.cumulative_created),a&&e.cumulative_updated!==void 0&&(a.textContent=e.cumulative_updated),d&&e.cumulative_errors!==void 0&&(d.textContent=e.cumulative_errors)}function completeAjaxExport(e,t,s,r){addLogEntry(swiftCSV.messages.exportCompleted,"success","export");const l=new Blob([e],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(l),o=new Date,n=o.getFullYear()+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0")+"_"+String(o.getHours()).padStart(2,"0")+"-"+String(o.getMinutes()).padStart(2,"0")+"-"+String(o.getSeconds()).padStart(2,"0"),a=`swiftcsv_export_${r}_${n}.csv`,d=document.querySelector("#export-download-btn");d&&(d.href=c,d.download=a,d.classList.add("enabled")),t&&(t.disabled=!1,t.value=swiftCSV.messages.exportCsv),s&&(s.style.display="none"),addLogEntry(swiftCSV.messages.downloadReady+" "+a,"info","export")}function completeAjaxImport(e,t,s){const r=e.dry_run||!1;if(addLogEntry(r?"[Dry Run] "+swiftCSV.messages.dryRunCompleted:swiftCSV.messages.importCompleted,"success","import"),e.cumulative_created!==void 0){const n=r?"[Dry Run] "+swiftCSV.messages.dryRunCreated+" ":swiftCSV.messages.totalImported+" ";addLogEntry(n+e.cumulative_created,"success","import")}if(e.cumulative_updated!==void 0){const n=r?"[Dry Run] "+swiftCSV.messages.dryRunUpdated+" ":swiftCSV.messages.totalUpdated+" ";addLogEntry(n+e.cumulative_updated,"success","import")}if(e.cumulative_errors!==void 0){const n=r?"[Dry Run] "+swiftCSV.messages.dryRunErrors+" ":swiftCSV.messages.totalErrors+" ";addLogEntry(n+e.cumulative_errors,e.cumulative_errors>0?"warning":"success","import")}t&&(t.disabled=!1,t.textContent=swiftCSV.messages.startImport),s&&(s.style.display="none");const l=document.querySelector("#ajax_csv_file"),c=document.querySelector("#csv-file-upload"),o=document.querySelector("#csv-file-info");l&&(l.value=""),c&&(c.style.display="block"),o&&(o.style.display="none")}const licenseInput=document.getElementById("swift_csv_pro_license_key_input"),licenseToggle=document.getElementById("swift_csv_pro_license_toggle_visibility");licenseInput&&licenseToggle&&licenseToggle.addEventListener("click",()=>{const e=licenseInput.type==="password";licenseInput.type=e?"text":"password",licenseToggle.textContent=e?swiftCSV.messages.hide:swiftCSV.messages.show});async function wpPost(e,t={}){const s=new URLSearchParams({action:e,...t});return(await fetch(swiftCSV.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s})).json()}document.body.addEventListener("click",async e=>{const t=e.target.closest(".swift-csv-license-button");if(!t)return;const s=t.dataset.action;if(!s){console.error("No action found on button:",t);return}console.log("License button clicked:",s);const r=document.getElementById("swift_csv_pro_license_key_input"),l=r?r.value:"",c=t.closest("div")?t.closest("div").querySelector(".spinner"):null;if(!l&&s==="activate"){alert(__("Please enter a license key.","swift-csv-pro"));return}console.log("Sending license request:",{action:s,licenseKey:l.substring(0,10)+"..."}),t.disabled=!0,c&&(c.style.visibility="visible");try{const o=await wpPost("swift_csv_pro_manage_license",{nonce:swiftCSV.nonce,license_key:l,license_action:s});if(console.log("License response:",o),!o.success)throw new Error(o.data?.message||__("License operation failed.","swift-csv-pro"));location.reload()}catch(o){console.error("License error:",o),alert(o.message||__("An error occurred while processing your request. Please try again.","swift-csv-pro"))}finally{t.disabled=!1,c&&(c.style.visibility="hidden")}});
